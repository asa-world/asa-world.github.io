let index=0;let origin="zhihu";let direction="after";let show_only=false;get_day_news(0,origin);show_only=true;setTimeout(()=>{Notiflix.Notify.warning("正在请求最新数据...");first_xhr()},1e3);function report_bug(){window.open("https://github.com/zkeq/news/issues/new?assignees=zkeq&labels=bug%2Capi&template=main.yaml&title=%5B%E6%8E%A5%E5%8F%A3%E5%A4%B1%E6%95%88%5D%3A+")}function handleError(e){if(origin==="zhihu"){console.log(e);if(e.data.news==="zhihu"){if(direction==="before"){if(index<0){direction="after";index=0}get_day_news(index=index-1,origin);bing_load(index);Notiflix.Notify.failure(`当天新闻不存在，尝试获取前一天 \uD83D\uDE1E ${e.data.title}`)}else{Notiflix.Notify.failure(`当天新闻不存在，尝试获取后一天 \uD83D\uDE1E ${e.data.title}`);get_day_news(index=index+1,origin);bing_load(index)}}else{NProgress.done();Notiflix.Notify.failure(`An error occurred \uD83D\uDE1E ${e["data"]["title"]}`,()=>report_bug())}}else{NProgress.done();Notiflix.Notify.failure(`An error occurred \uD83D\uDE1E ${e["data"]["title"]}`,()=>report_bug())}}function handleError_zhihu(e){NProgress.done();if(direction==="before"){get_day_news(index,origin);bing_load(index);Notiflix.Notify.failure(`当天新闻不存在，尝试获取前一天 \uD83D\uDE1E ${e}`)}else{Notiflix.Notify.failure(`当天新闻不存在，尝试获取后一天 \uD83D\uDE1E ${e}`);get_day_news(index,origin);bing_load(index)}}function handleError_163(e){NProgress.done();Notiflix.Notify.failure(`网易新闻源：An error occurred \uD83D\uDE1E ${e}`,()=>report_bug())}function get_bing_into_local_storage(){const t=new XMLHttpRequest;t.open("GET","https://raw.onmicrosoft.cn/Bing-Wallpaper-Action/main/data/zh-CN_all.json");t.onload=function(){if(t.status===200){const e=JSON.parse(t.responseText);localStorage.setItem("bing",JSON.stringify(e));bing_load(index)}else{handleError("Bing 获取失败")}};t.onerror=handleError;t.send()}function first_xhr(){const e=(new Date).getHours()+"hrs"+(new Date).getMinutes()+"min";try{const t=new XMLHttpRequest;t.open("GET","/api?origin=zhihu&_vercel_no_cache=1"+"&cache="+e);t.onload=zhihu_first_load;t.onerror=handleError_zhihu;t.send()}catch(e){handleError_zhihu(e)}try{const n=new XMLHttpRequest;n.open("GET","/api?origin=163&_vercel_no_cache=1"+"&cache="+e);n.onload=_163_init_load;n.onerror=handleError_163;n.send()}catch(e){handleError_163(e)}}function str_to_date(e){const t=/(\d{4})年?(\d{1,2})月(\d{1,2})日?/;const n=e.match(t);if(n){return`${n[1]}-${n[2]}-${n[3]}`}else{const i=(new Date).getFullYear();const n=e.match(/(\d{1,2})月(\d{1,2})日?/);if(n){return`${i}-${n[1]}-${n[2]}`}}return e}function zhihu_first_load(){try{const e=JSON.parse(this.responseText);if(e["suc"]){days_load.call(this,show_only=false);Notiflix.Notify.success("当前知乎数据源为最新数据");const t=str_to_date(e["data"]["date"]);localStorage.setItem("zhihu_cache",t)}else{handleError_zhihu(e["data"]["title"])}}catch(e){handleError_zhihu(e)}}function _163_init_load(){try{const e=JSON.parse(this.responseText);if(e["suc"]){Notiflix.Notify.success("当前网易新闻数据源为最新数据");const t=str_to_date(e["data"]["date"]);localStorage.setItem("163_cache",t)}else{handleError_163(e["data"]["title"])}}catch(e){handleError_163(e)}}function weiyu_load(){NProgress.done();const e=JSON.parse(this.responseText);document.getElementById("weiyu").innerHTML=e["hitokoto"]}function get_now_str(){if(origin==="zhihu"){return"知乎"}if(origin==="163"){return"网易新闻"}}function days_load(t){try{NProgress.done();const e=JSON.parse(this.responseText);if(e["suc"]){data=e["data"];if(data["date"].includes("月")){document.getElementById("date").innerHTML=data["date"]}else{document.getElementById("date").innerHTML="暂无数据"}try{const n=str_to_date(data["date"]);const i=get_now_str();Notiflix.Notify.success(`${i}源: ${n} 更新成功`,{showOnlyTheLastOne:t})}catch(e){const i=get_now_str();Notiflix.Notify.success(`${i}源: 更新成功`,{showOnlyTheLastOne:t})}if(data["weiyu"].includes("【微语】")){document.getElementById("weiyu").innerHTML=data["weiyu"].replace("【微语】","")}else{const o=new XMLHttpRequest;o.open("GET","https://v1.hitokoto.cn");o.onload=weiyu_load;o.onerror=handleError;o.send()}document.getElementById("news").innerHTML="";for(let e=0;e<data["news"].length;e++){const r=document.createElement("li");r.innerHTML=data["news"][e];document.getElementById("news").appendChild(r)}}else{handleError(e)}}catch(e){handleError(e)}}function bing_click(){window.open(document.getElementById("bing").src.split("_1920x1080.jpg")[0]+"_UHD.jpg")}cache_admin();function cache_admin(){if(localStorage.getItem("bing_cache")){const e=localStorage.getItem("bing_cache");const t=new Date;if(t-e>60*60*6*1e3){get_bing_into_local_storage();const n=Date.now();localStorage.setItem("bing_cache",n)}else{bing_load(index)}}else{get_bing_into_local_storage();const n=Date.now();localStorage.setItem("bing_cache",n)}}function bing_load(e){const t=JSON.parse(localStorage.getItem("bing"));if(e>=t["data"].length){const i=Math.floor(e/t["data"].length);index_num=e-t["data"].length*i}else{index_num=e}const n="https://cn.bing.com"+t["data"][index_num]["url"];document.getElementById("bing").src=n}function get_day_news(e,t){try{NProgress.start();const n=new XMLHttpRequest;if(t==="zhihu"){cache=localStorage.getItem("zhihu_cache")}else{cache=localStorage.getItem("163_cache")}n.open("GET",`/api?index=${e}&cache=${cache}&origin=${t}`);n.onload=days_load;n.onerror=handleError;n.send()}catch(e){handleError(e)}}function after(){if(index===0){Notiflix.Notify.success("当前已经是最新的了")}else{index-=1;direction="before";get_day_news(index,origin);bing_load(index)}}function before(){if(index===99){Notiflix.Notify.warning("之后没有了")}else{index+=1;direction="after";get_day_news(index,origin);bing_load(index)}}document.onkeydown=change_page;function change_page(){if(event.keyCode==37||event.keyCode==33){before()}else if(event.keyCode==39||event.keyCode==34){after()}if(event.keyCode==13){if(origin==="zhihu"){origin="163"}else{origin="zhihu"}get_day_news(index,origin)}}function change_origin(){if(origin==="zhihu"){origin="163";setTimeout(()=>{Notiflix.Notify.success("成功切换源为网易新闻")},1e3)}else{origin="zhihu";setTimeout(()=>{Notiflix.Notify.success("成功切换源为知乎")},1e3)}get_day_news(index,origin)}