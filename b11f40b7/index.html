<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>中小型园区网络构建（二）—— SDN网络应用的设计与实现 | Asa-World</title><meta name="keywords" content="园区网络,SDN"><meta name="author" content="阿傻"><meta name="copyright" content="阿傻"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="img-color" content="#033a60"><meta name="description" content="网络应用介绍及原理 NAPT介绍 NAT是将IP数据包头中的IP地址转换为另一个IP地址的过程。在实际应用中，NAT主要用于实现私有网络访问公共网络的功能。这种通过使用少量的公有IP地址代表较多的私有IP地址的方式，将有助于减缓可用IP地址空间的枯竭。 NAT的基本工作原理是当私有网主机和公共网主机通信的IP包经过NAT网关时，将IP包中的源IP或目的IP在私有IP和NAT的公共IP之间进行转换。"><meta property="og:type" content="article"><meta property="og:title" content="中小型园区网络构建（二）—— SDN网络应用的设计与实现"><meta property="og:url" content="https://asa-world.cn/b11f40b7/index.html"><meta property="og:site_name" content="Asa-World"><meta property="og:description" content="网络应用介绍及原理 NAPT介绍 NAT是将IP数据包头中的IP地址转换为另一个IP地址的过程。在实际应用中，NAT主要用于实现私有网络访问公共网络的功能。这种通过使用少量的公有IP地址代表较多的私有IP地址的方式，将有助于减缓可用IP地址空间的枯竭。 NAT的基本工作原理是当私有网主机和公共网主机通信的IP包经过NAT网关时，将IP包中的源IP或目的IP在私有IP和NAT的公共IP之间进行转换。"><meta property="og:locale"><meta property="og:image" content="https://image.asa-world.cn/pic/1242.png"><meta property="article:published_time" content="2023-07-17T09:20:27.000Z"><meta property="article:modified_time" content="2023-09-12T05:42:25.257Z"><meta property="article:author" content="阿傻"><meta property="article:tag" content="SDN"><meta property="article:tag" content="Python"><meta property="article:tag" content="计算机网络"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://image.asa-world.cn/pic/1242.png"><link rel="shortcut icon" href="data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAyMDQ4IDE4NjUiIHdpZHRoPSIxMjgwIiBoZWlnaHQ9IjEyODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxwYXRoIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEwMTAsMTYpIiBkPSJtMCAwaDI2bDQ5IDIgMzUgMyA0MCA1IDQwIDcgMzcgOCAzNSA5IDMzIDEwIDM4IDEzIDI4IDExIDMwIDEzIDI2IDEyIDE1IDggMTYgOCAyNyAxNSAyMCAxMiAxNCA5IDExIDcgMTYgMTEgMTQgMTAgMTggMTMgMTQgMTEgMTYgMTMgMTAgOCA5IDggOCA3IDkgOSA5IDcgMTIgMTEgMjYgMjYgMTEgMTQgMTMgMTMgNyA5IDcgOCA5IDExIDEzIDE2IDI2IDM2IDIwIDMwIDEyIDE5IDE1IDI2IDEyIDIyIDkgMTcgMTEgMjMgMTMgMjkgMTEgMjcgMTMgMzYgMTEgMzQgMTAgMzcgNyAyOSA4IDQyIDcgNDkgMyAzMCAyIDMyIDEgMzN2MjZsLTEgMzQtMyA0MS00IDM2LTYgMzgtOCA0MC0xMiA0OC0xMiAzOS0xMiAzNC0xMyAzMy0xNiAzNi0yMiA0NC0xMyAyMy0xNSAyNS0xMiAxOS04IDEyLTE0IDIwLTEzIDE4LTcgOS0xNiAyMC05IDExLTEyIDE0LTExIDEyLTE0IDE2LTEyIDEzLTE2IDE2LTggNy0xMCA4LTcgNy04IDctMTAgOC02IDYtNSAzLTkgOC0xNCAxMS0yNCAxOC0xMiA4LTE0IDEwLTIyIDE0LTEzIDgtMTcgMTAtMjcgMTUtNDAgMjAtMjQgMTEtMzQgMTQtMjcgMTAtMzYgMTItMzUgMTAtMzcgOS00MSA4LTM5IDYtNDkgNS0zNSAyaC03NWwtMzUtMi00MC00LTM2LTUtNDMtOC0zOC05LTQwLTExLTM2LTEyLTIyLTgtMjgtMTEtMzgtMTctNDQtMjItMjMtMTMtMjItMTMtMTctMTEtMTgtMTItMTktMTMtMTYtMTItMTEtOC0xMS05LTE1LTEyLTgtNy0xMS05LTEzLTEzLTktNy0xNS0xNC0yMy0yMy0xMS0xNC0xNS0xNS00LTYtNy03LTYtOC05LTExLTgtMTAtMTItMTYtMTItMTctMTMtMTktMTUtMjMtMTUtMjUtMTMtMjMtMTQtMjctOC0xNi0xMy0yOC0xMi0yOS0xMC0yNy0xNC00MS0xMi00My03LTI5LTktNDYtNi00Mi00LTQwLTItMzR2LTc5bDMtNDUgNS00MyA3LTQzIDktNDMgMTItNDUgOC0yNSAxMS0zMyAxNS0zOCAxNi0zNiA4LTE3IDEwLTE5IDExLTIxIDE0LTI0IDYtMTAgMTQtMjIgOC0xMiAxNC0yMCAxMy0xOCA3LTkgMTYtMjAgNS02IDctOCA4LTEwIDEwLTEwIDktMTEgNy04IDEyLTEzaDJ2LTJsNS01IDEzLTEyIDgtNyAxMS05IDExLTExIDgtNiA4LTcgMTEtOSAxNi0xMyAxOC0xMyAxNS0xMSAyNy0xOCAxNC05IDI1LTE1IDIzLTEzIDI5LTE1IDE2LTggMjktMTMgMjktMTIgMjctMTAgMzUtMTIgNDctMTMgMzAtNyAzNS03IDQ2LTcgMzgtNCAzMi0yeiIgZmlsbD0iIzE1MTQxNCIvPgo8cGF0aCB0cmFuc2Zvcm09InRyYW5zbGF0ZSg2MjYsNTE5KSIgZD0ibTAgMGg2OGwyIDEgMTYgMSAyNiA1IDE3IDQgMTcgNSAyNyAxMCAxNiA3IDE2IDggMTYgOSAyNCAxNSAxNSAxMSAxMiA5IDEwIDggMTAgOSA5IDcgOCA4IDggNyA1IDQgNyA4IDE0IDE0IDcgOCAxNCAxNCA0IDYgMTEgMTIgNyA4IDIgNSAzIDEtMyA1LTggMTAtMTQgMTgtMTMgMTYtMTAgMTMtMTIgMTUtMTEgMTQtMTIgMTUtMTEgMTQtMTIgMTUtMjIgMjgtMTMgMTYtMTAgMTMtMi0zLTgtMTEtNy05LTctOC0xMy0xNi0xMS0xMy0xNS0xNi0xMS0xMi05LTEwLTgtNy0xMi0xMS0xNy0xMy0xOS0xMi0xMy03LTE3LTYtNi0yLTEzLTEtMy0yaC0zM2wtOCAyLTEyIDItMTQgNC0yMSA5LTE1IDktMTQgMTAtMTIgMTEtNyA4LTggMTAtMTAgMTUtOSAxOS00IDktMSA1LTQgMTMtMiAxMHY0OGw1IDIyIDggMjEgOSAxNyA5IDEzIDggMTAgMTYgMTYgMTggMTMgMTggMTAgMTcgNyAxMSAzIDcgMiAxMCAxIDIgMSAxMCAxaDIzbDE3LTMgMTYtNSAyNS0xMiAxNC05IDEzLTEwIDE0LTEyIDM3LTM3IDgtMTAgMTMtMTQgNi04IDgtOSAyMC0yNiA1LTUgMTAtMTEgMjItMjggMTMtMTYgMTAtMTMgMTMtMTYgMTAtMTMgMTItMTUgMTMtMTcgMTQtMTcgMjItMjggMTItMTUgNS04IDEwLTExIDctOSAyMS0yMSA3LTggMTItMTIgOC03IDEzLTEzIDgtNyAxNi0xMyAxMS05IDEwLTggMjMtMTYgMjEtMTMgMjMtMTMgMTctOCAxNC03IDYtMiAxLTFoNmwxLTNoNnYtMmg4di0zaDZsMi0yaDh2LTNsMTEtMSA3LTIgNS0yIDE0LTEgNy0yIDE1LTEgMS0xaDY4bDEgMSAxOCAxIDggMiAxMyAyIDIwIDQgNSAyIDE2IDQgMjEgNyAyNCAxMCAyOSAxNCAxOSAxMSAxOCAxMiAxOSAxNCAxMyAxMSAxNCAxMiAyMSAyMSA2IDd2MmgybDExIDE0IDkgMTIgMTMgMTkgNyAxMSAxMyAyMiAxMyAyOSA1IDEyIDQgMTEgMiA1IDIgNyAxIDF2OGgybDEgOSAyIDEgMSA5IDIgNSAxIDggMSAxIDEgMTMgMiAzIDEgMTkgMiA1djY3bC0yIDQtMSAyNC0yIDQtMSAxMy0zIDE1LTQgMTYtMTEgMzMtOCAyMS0yIDEtMSA0LTQgOC00IDctMTEgMjAtNCAxMC0yIDQtNCA0LTMgNS02IDctOSAxMy0xMCAxNC0xNyAxNy05IDExLTMgM2gtMmwtMiA0LTMgMnYtMmwtNSA1aC0ybC0xIDMtNCA0IDEgMi02LTEtMSA0LTYgNC03IDYtMSAzLTUtMS01IDUtMSA0LTcgMy03IDRoLTN2MmgtNWwtMSA0LTEwIDYtNiA0LTggMy0xMCAydjJsLTQgMy02IDEtMSAyaC03bC0xIDMtNSAxLTYgMy03IDItNSAyLTUgMS00IDItNC0xIDEgMy03IDEtMiAyLTkgMi05IDEtNyAyLTEwIDEtNyAyLTE1IDMtMTcgMS0xMSAyaC0yN2wtMy0xLTE5IDEtNS0yLTIwLTItNi0yLTEyLTEtNC0yaC02bC0xNC00LTgtMnYtMmgtN2wtOS00LTUtMnYtMmwtNiAxLTEtMiAxLTItNSAyLTQtNC03LTEtNy0zLTktNi02LTMtNS0xLTE4LTEwLTE0LTEwLTMtMy01LTMtMTItNy03LTYtMTUtOS01LTctOS03aC01bC00LTgtNS0yLTgtNy0xLTItNC0xLTMtMy0xLTQtNS01LTUtMy02LTgtNS01LTUtM3YtM2wtNC0xLTMtMy0zLTUtMjEtMjF2LTRsLTQtMS04LTktMy0xLTggNy03IDktOSAxMC01IDYtOCA3LTcgNy0xIDQtMjQgMjQtNSAyLTEyIDEyLTMgNi0xMSA5LTEyIDEwLTEyIDloLTRsLTIgNC0xMyAxMC0xMSA3LTE1IDEwLTE3IDktOCAzLTggNS0yMSA5LTkgNC0xNiA0LTIwIDctMTYgMy03IDItMTcgMy0xNSAxLTQgMi0yMy0xLTEgMWgtMjRsLTQtMWgtMTJsLTMtMWgtMTFsLTE0LTMtMTMtMi0yNC01LTI0LTctMjEtNy0xMC0zLTItNC00IDEtMy0yLTEwLTMtNC01di0ybC02IDEtMTItNi00LTMtNy00LTEtMiAxLTItNCAxLTctNS04LTQtMTgtMTQtMy0zLTYtMy0xMi0xMC0xLTMtNS0zLTEtNC02LTMtNi02LTItNi00LTItMTItMTMtOC03LTMtMy0yLTUtMy0zLTItNS02LTN2LTRsLTQtMi00LTEwLTctMTAtNC04di0yaC0ybC0yLTItNC0zLTUtMTItNi0xMy0zLTctNy0xNS01LTE1LTMtMTAtMy01LTEtNi0yLTktMy05LTMtMTQtMS0yLTEtMTUtMi05di0xOGgtMnYtNzRsMi0xMCAxLTEzIDEtMSAxLTEyIDItNSAxLTExIDItNHYtNGgybDEtMTAgMi0ydi02aDJsMS04aDJsMi05IDUtMTUgNy0xNSAxMy0yNyAxMS0xOSA0LTVoMmwzLTkgNS02IDYtOSAzLTUgOC0xMCA3LTggNi03IDEtMyA4LTYgMTQtMTMgOC03IDgtOCAxNy0xMyAxOC0xMyAyMS0xMyAxOS0xMSAyMS05IDgtNCA1LTEgMi0zIDQgMXYtM2g5bDEtMyA2IDEtMS0zaDl2LTJsNy0xIDctMyAxNS0zIDEtMSAxMy0yIDEtMSAxNC0xIDktMiAxMy0xeiIgZmlsbD0iI0ZERkRGRCIvPgo8cGF0aCB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMzY5LDc1NSkiIGQ9Im0wIDBoMzJsMjAgNHYybDYtMSAxNiA2IDE2IDggMTIgNyAxMSA4IDE1IDEzIDkgMTAgNyA5IDEyIDE5IDggMTcgNyAyMiAxIDkgMSAxIDIgMTh2MTNsLTEgMTctMiA3LTEgOS01IDE3LTUgMTItOSAxNy04IDEyLTggMTAtOSAxMC0xMiAxMS0xNyAxMi0xOSAxMC0xMiA1LTkgMy0xMCAyLTEgMS0xMSAxLTEgMS0xMCAxaC0yMWwtMTgtMy02LTItMTAtMy0xNi04LTE1LTgtMTktMTMtMTQtMTEtMTAtOS0xMS05LTM2LTM2LTctOC05LTEwLTktMTEtOS0xMC0xMS0xNC0zLTItOCA5LTEyIDE2LTExIDE0LTI4IDM2LTEwIDEzLTI4IDM2LTEwIDEzLTE0IDE4LTEwIDEzLTE0IDE4LTIgMmgtM2wxLTUgMTQtMTggMTAtMTMgMTQtMTggMTAtMTMgNDItNTQgMTMtMTcgMTEtMTQgMTQtMTggMTAtMTMgOS0xMCA4LTEwIDktMTEgMTItMTQgOS0xMCAzLTMgMi0xIDQtNyAyMC0yMCA3LTggMy0zaDJ2LTJsOC03IDctNyAxMS05IDE1LTEyIDIxLTE0IDE0LTggMTgtOCAxMi00IDEyLTF6IiBmaWxsPSIjMTUxNDE0Ii8+Cjwvc3ZnPg=="><link rel="canonical" href="https://asa-world.cn/b11f40b7/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google-site-verification" content="TD9p9zZ_1L-PgzXQIkZXcvCFgq6f-DTDUmTUYy_omIU"><meta name="baidu-site-verification" content="code-DrR5DPhveh"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/node-snackbar/0.1.16/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="/third_local/fancybox_min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!0,languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:250},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#1f1f1f",position:"top-center"},source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"中小型园区网络构建（二）—— SDN网络应用的设计与实现",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-09-12 13:42:25"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const n=864e5*o,a={value:t,expiry:(new Date).getTime()+n};localStorage.setItem(e,JSON.stringify(a))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=o,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,t())},document.head.appendChild(n)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme");"dark"===t?activateDarkMode():"light"===t&&activateLightMode();const o=saveToLocal.get("aside-status");void 0!==o&&("hide"===o?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/asa_case.css"><link rel="stylesheet" href="/css/asa_case_fitscreen.css"><link rel="stylesheet" href="/css/font/iconfont.css"><link rel="stylesheet" href="/css/comments.css"><link rel="apple-touch-icon" href="https://image.asa-world.cn/pic/fangxingtubiao.png"><meta name="apple-mobile-web-app-title" content="Asa-World"><link rel="bookmark" href="https://image.asa-world.cn/pic/fangxingtubiao.png"><link rel="apple-touch-icon-precomposed" sizes="180x180" href="https://image.asa-world.cn/pic/fangxingtubiao.png"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"><style>#recent-posts>.recent-post-item>.recent-post-info>.article-meta-wrap>.tags:before{content:"\A";white-space:pre}#recent-posts>.recent-post-item>.recent-post-info>.article-meta-wrap>.tags>.article-meta__separator{display:none}</style><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@1.0.17/lib/tag_plugins.css" media="defer" onload='this.media="all"'><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><meta name="generator" content="Hexo 6.2.0"><link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head><body><body></body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="sidebar" style="zoom:1"><div id="menu-mask"></div><div id="sidebar-menus"><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" data-pjax-state="" href="javascript:void(0);" onclick="switchDarkMode()" rel="external nofollow" title="显示模式切换"><i class="iconfont icon-igw-f-sun" style="font-size:1rem"></i><span>显示模式</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" data-pjax-state="" href="javascript:void(0);" rel="external nofollow"><span>文库</span></a><ul class="menus_item_child"><li><a class="child site-page" data-pjax-state="" href="/categories/"><i class="iconfont icon-fenlei"></i><span>全部专栏</span></a></li><li><a class="child site-page" data-pjax-state="" href="/tags/"><i class="iconfont icon-24gf-tags2"></i><span>全部标签</span></a></li><li><a class="child site-page" data-pjax-state="" href="/archives/"><i class="iconfont icon-wenzhang2"></i><span>文章列表</span></a></li></ul></div><div class="menus_item"><a class="site-page" data-pjax-state="" href="javascript:void(0);" rel="external nofollow"><span>我的</span></a><ul class="menus_item_child"><li><a class="child site-page" data-pjax-state="" href="/comments/"><i class="iconfont icon-liuyanxiaoxi"></i><span>留言板</span></a></li><li><a class="child site-page" data-pjax-state="" href="/reading/"><i class="iconfont icon-dushu"></i><span>读书笔记</span></a></li><li><a class="child site-page" data-pjax-state="" href="/Update_log/"><i class="iconfont icon-gengxin"></i><span>更新日志</span></a></li><li><a class="child site-page" data-pjax-state="" href="/about/"><i class="iconfont icon-website_fill"></i><span>关于本站</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-allinfo card-archives card-tags card-webinfo card-widget"><div class="tag-cloud-list is-center"><a href="/tags/%E9%80%9A%E4%BF%A1%E7%9B%B8%E5%85%B3/" style="font-size:1.38em;color:#57810b">通信相关</a><a href="/tags/%E5%AD%A6%E7%94%9F%E7%AB%9E%E8%B5%9B/" style="font-size:1.44em;color:#4c3f1f">学生竞赛</a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:1.31em;color:#749960">算法</a><a href="/tags/SDN/" style="font-size:1.38em;color:#567e13">SDN</a><a href="/tags/Python/" style="font-size:1.5em;color:#259938">Python</a><a href="/tags/%E5%8E%86%E5%8F%B2/" style="font-size:1.25em;color:#27679d">历史</a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/" style="font-size:1.31em;color:#bc97a4">计算机</a><a href="/tags/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/" style="font-size:1.19em;color:#5d4eb5">博客搭建</a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size:1.31em;color:#3028a8">后端</a><a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size:1.06em;color:#87bb67">前端</a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size:1.06em;color:#9a8768">数据库</a><a href="/tags/%E9%A1%B6%E5%B1%82%E8%AE%BE%E8%AE%A1/" style="font-size:1.13em;color:#bf37aa">顶层设计</a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size:1.31em;color:#ba2a45">计算机网络</a><a href="/tags/Apple/" style="font-size:1em;color:#19667f">Apple</a><a href="/tags/%E8%8B%B1%E8%AF%AD/" style="font-size:1em;color:#2557a2">英语</a><a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size:1.06em;color:#165d2c">C语言</a><a href="/tags/%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/" style="font-size:1em;color:#c70726">应用程序</a><a href="/tags/%E6%9C%BA%E5%99%A8%E8%A7%86%E8%A7%89/" style="font-size:1.31em;color:#9d5b6e">机器视觉</a><a href="/tags/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/" style="font-size:1.13em;color:#a0642d">论文阅读</a><a href="/tags/%E5%8D%95%E7%89%87%E6%9C%BA/" style="font-size:1.19em;color:#141e77">单片机</a><a href="/tags/%E5%93%B2%E5%AD%A6/" style="font-size:1em;color:#36713f">哲学</a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size:1.13em;color:#8a35a4">数学</a><a href="/tags/%E7%94%9F%E6%B4%BB%E5%90%91/" style="font-size:1.06em;color:#c19090">生活向</a><a href="/tags/%E5%8C%BB%E5%AD%A6/" style="font-size:1em;color:#c66284">医学</a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg nav-fixed nav-visible" id="page-header" style="background-image:url(https://image.asa-world.cn/pic/1242.png)"><nav id="nav"><span id="blog_name"><div class="back-home-button" tabindex="-1"><i class="back-home-button-icon fa-grip-vertical fas"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">专栏</div><div class="back-menu-list"><div class="category-lists"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%A8%E6%A0%B9%E9%97%AE%E5%BA%95/">刨根问底</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8E%9F%E5%88%9B%E5%B9%B2%E8%B4%A7/">原创干货</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/">实验报告</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%AC%E7%A7%91%E5%AD%A6%E4%B9%A0/">本科学习</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%97%AE%E9%A2%98%E4%BF%AE%E5%A4%8D/">问题修复</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/">项目开发</a><span class="category-list-count">13</span></li></ul><div class="is-center tag-cloud-list"></div></div></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">标签</div><div class="back-menu-list"><div class="tag-cloud-list is-center tag-nav"><a href="/tags/%E9%80%9A%E4%BF%A1%E7%9B%B8%E5%85%B3/" style="font-size:1em;color:#c724af">通信相关</a><a href="/tags/%E5%AD%A6%E7%94%9F%E7%AB%9E%E8%B5%9B/" style="font-size:1em;color:#6a9e4f">学生竞赛</a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:1em;color:#7c3941">算法</a><a href="/tags/SDN/" style="font-size:1em;color:#052270">SDN</a><a href="/tags/Python/" style="font-size:1em;color:#b7bf71">Python</a><a href="/tags/%E5%8E%86%E5%8F%B2/" style="font-size:1em;color:#4865b4">历史</a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/" style="font-size:1em;color:#ac758f">计算机</a><a href="/tags/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/" style="font-size:1em;color:#081f63">博客搭建</a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size:1em;color:#5d8a77">后端</a><a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size:1em;color:#33517c">前端</a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size:1em;color:#32924e">数据库</a><a href="/tags/%E9%A1%B6%E5%B1%82%E8%AE%BE%E8%AE%A1/" style="font-size:1em;color:#b946a5">顶层设计</a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size:1em;color:#7e6d36">计算机网络</a><a href="/tags/Apple/" style="font-size:1em;color:#0aaea4">Apple</a><a href="/tags/%E8%8B%B1%E8%AF%AD/" style="font-size:1em;color:#1cafb6">英语</a><a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size:1em;color:#0d2a3a">C语言</a><a href="/tags/%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/" style="font-size:1em;color:#221185">应用程序</a><a href="/tags/%E6%9C%BA%E5%99%A8%E8%A7%86%E8%A7%89/" style="font-size:1em;color:#7fa442">机器视觉</a><a href="/tags/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/" style="font-size:1em;color:#6783b5">论文阅读</a><a href="/tags/%E5%8D%95%E7%89%87%E6%9C%BA/" style="font-size:1em;color:#950027">单片机</a><a href="/tags/%E5%93%B2%E5%AD%A6/" style="font-size:1em;color:#44547e">哲学</a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size:1em;color:#355097">数学</a><a href="/tags/%E7%94%9F%E6%B4%BB%E5%90%91/" style="font-size:1em;color:#014568">生活向</a><a href="/tags/%E5%8C%BB%E5%AD%A6/" style="font-size:1em;color:#761028">医学</a></div></div></div></div></div><a id="site-name" href="/"><div class="title"></div><i class="iconfont icon-01_shangjiaguanli"></i></a></span><div class="mask-name-container"><center id="name-container"><a id="page-name" href="javascript:rmf.scrollToTop()" rel="external nofollow noreferrer">PAGE_NAME</a></center></div><div id="menus"><div class="nav-button" id="darkmode_navswitch"><a class="darkmode_switchbutton" type="button" title="模式切换" onclick="switchDarkMode()"><i class="iconfont icon-igw-f-sun"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" title="搜索文章"><i class="iconfont icon-sousuo1 fa-fw"></i><span> 搜索</span></a></div><div class="nav-button" id="nav-totop"><a class="totopbtn" title="返回顶部"><i class="iconfont icon-Upxiangshang7"></i><span id="percent" onclick="btf.scrollToDest(0,500)">0</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/archives/"><span>文章</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><span>专栏</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><span>我的</span><i class="iconfont icon-xiangxia"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/comments/"><i class="fa-fw iconfont icon-liuyanxiaoxi"></i><span> 留言板</span></a></li><li><a class="site-page child" href="/reading/"><i class="fa-fw iconfont icon-dushu"></i><span> 读书笔记</span></a></li><li><a class="site-page child" href="/Update_log/"><i class="fa-fw iconfont icon-gengxin"></i><span> 更新日志</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw iconfont icon-website_fill"></i><span> 关于本站</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="iconfont icon-liebiao1" style="font-size:1.1em"></i></a></div></div></nav><div id="post-info"><div id="post-first-meta"><div class="meta-firstline"><span class="post-meta-categories"><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/">项目开发</a></span><span class="post-meta-tags"><div class="meta-tag"><span class="sign">#</span><a class="post-meta-tags" href="/tags/SDN/">SDN</a></div><div class="meta-tag"><span class="sign">#</span><a class="post-meta-tags" href="/tags/Python/">Python</a></div><div class="meta-tag"><span class="sign">#</span><a class="post-meta-tags" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a></div></span></div></div><div id="post-meta"><h1 class="post-title">中小型园区网络构建（二）—— SDN网络应用的设计与实现</h1><div class="meta-secondline"><span class="post-meta-wordcount"><i class="iconfont icon-file-word"></i><span class="word-count">14.8k</span></span><span class="post-meta-pv-cv" data-flag-title="中小型园区网络构建（二）—— SDN网络应用的设计与实现"><i class="iconfont icon-huo"></i><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-date"><i class="iconfont icon-rili far fa-calendar-alt"></i><time datetime="2023-07-17T09:20:27.000Z" title="发表于 2023-07-17 17:20:27">2023-07-17</time></span></div></div></div><div class="coverdiv loaded" id="coverdiv"><img class="entered loading nolazyload" id="post-cover" alt="cover" data-ll-status="loading" src="https://image.asa-world.cn/pic/1242.png"></div><div class="weidiv" id="weidiv"></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><div class="top-img gist" style="background-image:url(https://image.asa-world.cn/pic/1242.png)"></div><article class="post-content" id="article-container"><h1 id="网络应用介绍及原理">网络应用介绍及原理</h1><h2 id="napt介绍">NAPT介绍</h2><p>NAT是将IP数据包头中的IP地址转换为另一个IP地址的过程。在实际应用中，NAT主要用于实现私有网络访问公共网络的功能。这种通过使用少量的公有IP地址代表较多的私有IP地址的方式，将有助于减缓可用IP地址空间的枯竭。</p><p>NAT的基本工作原理是当私有网主机和公共网主机通信的IP包经过NAT网关时，将IP包中的源IP或目的IP在私有IP和NAT的公共IP之间进行转换。</p><p>由于NAT实现是私有IP和NAT的公共IP之间的转换，那么，私有网中同时与公共网进行通信的主机数量就受到NAT的公共IP地址数量的限制。为了克服这种限制，NAT被进一步扩展到在进行IP地址转换的同时进行Port的转换，这就是网络地址端口转换NAPT（Network Address Port Translation）技术。NAPT也被称为“多对一”的NAT，或者叫PAT（Port Address Translations，端口地址转换）、地址超载（address overloading）。</p><p>NAPT与NAT的区别在于，NAPT不仅转换IP包中的IP地址，还对IP包中TCP和UDP的Port进行转换。这使得多台私有网主机利用1个NAT公共IP就可以同时和公共网进行通信。</p><h2 id="防火墙介绍">防火墙介绍</h2><p>防火墙是一种通过基于一组用户定义的规则过滤传入和传出网络流量来提供网络安全性的系统。通常，防火墙的目的是减少或消除不需要的网络通信的发生，同时允许所有合法通信自由流动。在大多数服务器基础架构中，防火墙提供了一个重要的安全层，与其他措施相结合，可以防止攻击者以恶意方式访问服务器。</p><p>有三种基本类型的网络防火墙：包过滤（无状态），有状态和应用层。</p><p>数据包过滤或无状态防火墙通过隔离检查单个数据包来工作。因此，他们不知道连接状态，并且只能根据各个数据包标头允许或拒绝数据包。</p><p>状态防火墙能够确定数据包的连接状态，这使得它们比无状态防火墙更灵活。它们通过收集相关数据包来工作，直到可以在将任何防火墙规则应用于流量之前确定连接状态。</p><p>应用程序防火墙通过分析传输的数据更进一步，这使得网络流量可以与特定于各个服务或应用程序的防火墙规则相匹配。这些也称为基于代理的防火墙。</p><p>除了在所有现代操作系统上都可用的防火墙软件之外，防火墙功能还可以由硬件设备提供，例如路由器或防火墙设备。</p><h2 id="dhcp中继介绍">DHCP中继介绍</h2><p>DHCP使用了租约的概念，或称为计算机IP地址的有效期。租用时间是不定的，主要取决于用户在某地连接Internet需要多久，这对于教育行业和其它用户频繁改变的环境是很实用的。透过较短的租期，DHCP能够在一个计算机比可用IP地址多的环境中动态地重新配置网络。DHCP支持为计算机分配静态地址，如需要永久性IP地址的Web服务器。</p><p>在大型的网络中，可能会存在多个网段。DHCP客户机通过网络广播消息获得DHCP服务器的响应后得到IP地址。但广播消息是不能跨越网段的。因此，DHCP客户机和服务器在不同的网段内时，客户机向服务器申请IP地址就要用到DHCP中继代理。DHCP中继代理实际上是一种软件技术，安装在DHCP中继代理的设备（路由器，交换机，服务器）称为DHCP中继代理服务器，它承担不同网段间的DHCP客户机和服务器的通信任务。</p><p>DHCP客户端启动并进行DHCP初始化时，它在本地网络广播配置请求报文。如果本地络存在DHCP服务器，则可以直接进行DHCP配置，不需要DHCP中继；如果本地网络没有DHCP服务器，则与本网络相连的且带DHCP中继功能的网络设备收到该广播报文后，进行适当的处理并转发给指定的在其它网络上的DHCP服务器。DHCP服务器根据客户端提供的信息进行相应的配置，并通过DHCP中继将配置信息发送给客户端，完成对客户端的动态配置。</p><h2 id="vrrp介绍">VRRP介绍</h2><p>现网中的主机使用缺省网关与外部网络联系时，如果Gateway出现故障，与其相连的主机将与外界失去联系，导致业务中断。VRRP的出现很好地解决了这个问题。VRRP将多台设备组成一个虚拟设备，通过配置虚拟设备的IP地址为缺省网关，实现缺省网关的备份。当网关设备发生故障时，VRRP机制能够选举新的网关设备承担数据流量，从而保障网络的可靠通信。如下图所示，当Master设备故障时，发往缺省网关的流量将由Backup设备进行转发。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230717202114248.png" alt="VRRP备份组示意图"></p><h2 id="应用服务器介绍">应用服务器介绍</h2><p><strong>Web服务器</strong>，是指驻留于因特网上某种类型计算机的程序。当Web浏览器（客户端）连到服务器上并请求文件时，服务器将处理该请求并将文件发送到该浏览器上，附带的信息会告诉浏览器如何查看该文件（即文WEB服务器件类型）。服务器使用HTTP（超文本传输协议）进行信息交流，这就是人们常把它们称为HTTPD服务器的原因。</p><p>Web服务器不仅能够存储信息，还能在用户通过Web浏览器提供的信息的基础上运行脚本和程序。</p><p><strong>FTP服务器</strong>，全称File Transfer Protocol Server，是在互联网上提供文件存储和访问服务的计算机，它们依照FTP协议提供服务。FTP，文件传输协议（File Transfer Protocol）是用于在网络上进行文件传输的一套标准协议，使用客户/服务器模式。FTP是专门用来传输文件的协议。</p><p>FTP是一个客户机/服务器系统，用户通过使用一个支持FTP协议的客户端，连接到远程主机上的服务器程序上。用户在客户端发出命令，远程主机服务器接收到命令后执行用户所发出的命令，同时将执行结果返回到客户端。简单来说，就是用户对服务器发出一条命令，要求服务器向用户发送一份文件，服务器响应并发送文件到客户端，用户收到文件将其放置于用户工作目录中，这一过程就是FTP服务器进行的文件交流。</p><h2 id="gre隧道介绍">GRE隧道介绍</h2><p>GRE 是在网络上建立直接点对点连接的一种方法，目的是简化单独网络之间的连接。它适用于各种网络层协议。将数据包封装在其他数据包中称为“隧道”。</p><p>GRE 隧道通常配置在两个路由器之间，每个路由器的作用好比隧道的一端。路由器设置为彼此直接发送和接收 GRE 数据包。两个路由器之间的任何路由器都不会打开封装的数据包；它们仅引用封装数据包外层的标头进行转发。</p><h1 id="方案设计">方案设计</h1><h2 id="napt设计">NAPT设计</h2><p>（一）需求分析</p><p>我们设计的网络中，为了节约公有地址的使用，因此我们选择利用NAPT技术对于我们的私网地址做一层转换，将我们的所有私有地址访问外网的时候，映射成同一个公有地址，实现地址的共享。并且利用NAPT技术也可以实现我们私有地址安全的进一步提升。而NAPT技术为了实现共用同一个公有地址，需要记录并改变报文的IP和TCP/UDP的端口号。因此我们需要利用流表项对于我们报文的IP和端口号进行改变。</p><p>并且我们发现在一些公司当中，会将服务器的IP暴露出来供他人进行ICMP访问，而我们这里并没有公网地址给我们的服务器使用，因此，我们需要也对我们的ICMP报文进行类似的NAPT技术应用，实现我们的ICMP报文的NAPT映射，而其中我们发现ICMP报文中标识这个参数可以进行修改，从而办到ICMP的地址映射技术。</p><p>（二）设计思路</p><p>在我们设计的网络中，将S7作为我们的NAPT地址映射的节点，在该节点下发流表实现我们的地址映射操作。并且由于NAPT需要一个公网地址，因此我们将我们的虚拟机网卡绑定在S7的一个端口上，并将该网卡的IP地址作为我们最终映射成的地址。由于我们采用的SDN网络架构，因此我们选择利用控制器编程实现地址映射，以及对应的流表下发功能。</p><p>其中我们所设计的NAPT流程可以划分为2种情况，一种是从外网接收发向内网的报文，一种是内网访问外网。</p><p>其中由内网发向外网流程如下所述：</p><ol><li>在网关接收到一个报文后，判断其是否有对应的流表进行匹配，如有匹配项，按照匹配进行转发。如果没有则发往控制器。</li><li>控制器判断目的地址是否为外网，如果不是则按照内网寻路和转发的方式进行报文转发。如果是则查看arp表是否记录虚拟机的网关，如果没有记录，则缓存报文，并向虚拟机发起arp请求。</li><li>当控制器有虚拟机网关mac信息后，根据NAPT映射方法，计算当前报文的源信息的映射情况，并寻路，随后下发NAPT映射流表，mac地址更改流表和路报文发流表。</li><li>根据映射结果，将报文的IP和端口号进行修改（如果为ICMP报文则为标识），并修改mac地址，最终将其发送到虚拟机网关。</li></ol><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230717203328417.png" alt="内网发向外网NAPT流程图"></p><p>其中由内网发向外网流程如下所述：</p><ol><li>在网关接收到一个报文后，判断其是否有对应的流表进行匹配，如有匹配项，按照匹配进行转发。如果没有则发往控制器。</li><li>控制器接收报文之后判断是否为目的地址和源地址都是外网，如果不是，则按照内网转发或者是发往外网的流程进行处理。如果是则判断目的地址和端口号是否有地址映射对应（如果是ICMP报文则为标识），如果没有记录则丢弃报文，如果有记录则对报文进行地址映射，将报文地址映射成内网地址。</li><li>判断是否为arp报文，如果是则记录其信息。如果不是则判断该报文映射后目的地址是否有arp记录，如果没有记录则缓存并进行arp请求。如果有则修改报文目的mac地址，随后下发NAPT映射流表，mac地址修改流表，最终按照内网转发报文的流程进行处理。</li></ol><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230717203341583.png" alt="外网发向内网NAPT流程图"></p><p>在该过程当中我们的NAPT的IP和端口映射算法如下所述：</p><ol><li>在控制器种我们首先利用一个映射表记录我们的NAPT映射情况。</li><li>随后将IP映射成虚拟机网卡的IP地址，端口首先映射成自己本身，检查是否这个映射的端口号是有记录的，如果有记录则将自己的映射端口号加一，直到没有记录过为止，随后记录该映射。</li></ol><p>并且在过程中涉及到流表项的下发，其中由内网发向外网流表如下所述：</p><ol><li>路径中的第一个openflow交换机：匹配为报文的目的IP地址，且目的mac为网关mac地址；作用为修改报文的mac地址为其虚拟机网关的mac地址以及转发该报文。</li><li>路径中的中间openflow交换机：匹配为报文的mac地址为虚拟机网关的mac地址（避免重复下发）；作用为转发报文。</li><li>路径中的最后一个openflow交换机（S7）：匹配为报文的IP地址为外网记录的的地址；作用为修改源IP地址和端口号做NAPT映射（如果是ICMP报文则为ICMP报文标识）和转发报文。</li></ol><p>另外，由外网发向内网流表如下所述：</p><ol><li>路径中的第一个openflow交换机：匹配为报文的目的IP地址为内网主机，且端口为指定端口；作用为修改报文的目的IP地址和端口号做NAPT映射（如果是ICMP报文则为ICMP报文标识）并修改mac地址为主机对应的mac地址，和实现报文转发。</li><li>路径中的后续openflow交换机：匹配为报文的目的IP地址；作用为转发报文。</li></ol><p>对于上述需求分析中，我们提及的ICMP报文的情况。因此我们设计的NAPT是包含了对于ICMP报文的处理，但ICMP报文并没有传输层的端口号，因此我们选择利用其ICMP报文中的标识进行我们的映射如下图所示，由于一次ping操作中连续的ICMP的ICMP报文标识是相同的，因此我们选择将短时间内记录ICMP标识和IP地址的映射情况，从而类比TCP报文的端口实现其NAPT功能。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230717203252208.png" alt="ICMP报文中的标识"></p><p>并且对于我们的服务器需要供外网进行访问，因此，我们需要提前将我们的服务器IP地址和我们的对应的端口号进行NAPT地址映射的记录。</p><h2 id="防火墙设计">防火墙设计</h2><p>（一）需求分析</p><p>在本组设计的SDN网络中，存在一个服务器网段与一个访客网段。因此我们选择配置防火墙对数据的传输进行过滤，以达成内外网的隔离及对服务器集群的保护。其中主要考虑在禁止访客网络和部分内部网络访问ftp服务器，以及允许服务器级群向外发送信息。同时还可以通过防火墙的设置对服务器的安全性进行一定提升。</p><p>（二）设计思路</p><p>由于本组的SDN网络是基于mininet和ryu控制器实现，所以选择使用ryu控制器自带的rest_firewall进行防火墙的实现。本方法对数据包的过滤是基于路由器的流表项，因此我们选择将控制器放在服务器集群的s11上便于专门对服务器的防火墙配置。</p><p>ryu的rest_firewall在开启后默认为禁止所有包的传输，因此我们要为这个交换机制订相应的规则打通数据传输的隧道。此处我们组制订的思路如下：</p><ol><li>允许所有源地址为192.168.4.0网段的报文通过，使服务器集群的数据能正常流出。</li><li>允许所有目的地址为web服务器，端口为80的报文通过，这样设置在访问web服务器时只能通过80端口，避免端口扫描等。</li><li>禁止icmp报文的通过，以此避免ddos攻击使服务器负载过大。</li><li>为部分内部网络开通访问ftp服务器，避免外网以及无权限内网访问ftp服务器。</li></ol><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230717203607801.png" alt="防火墙流程图"></p><h2 id="dhcp中继设计">DHCP中继设计</h2><p>（一）需求分析</p><p>在我们设计的网络中，分布着多个需要DHCP服务器分配IP地址的子网，而为了节省网络中搭建多个DHCP服务器造成的开支，我们选择在网络的汇聚层上搭建一个DHCP服务器复制分配多个子网的IP地址分配。这种网络搭建方案导致DHCP服务器和DHCP客户机位于不同网段；因此需要引入DHCP中继技术，将接入层的SDN交换机配置为DHCP中继代理，由其负责与DHCP服务器进行交互完成所属子网DHCP客户机的IP地址分配，最终实现网络中一个DHCP服务器完成不同子网IP地址的分配。</p><p>（二）设计思路</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230717203843309.png" alt="主干网拓扑图"></p><p>如主干网拓扑图所示，在我们设计的网络中，DHCP服务器与汇聚层交换机s4、s5相连;需要DHCP服务的三个主机网络为与s1、s2、s3相连，所属网段分别为192.168.1.0/24、192.168.2.0/24、192.168.3.0/24。为了实现DHCP中继，我们将s1、s2、s3指定为DHCP中继代理交换机，并分别将其与二层交换机s8、s9、s10相连的接口IP设置为相应子网网关192.168.1.254、192.168.2.254、192.168.3.254。</p><p>由于我们采用的网络架构为SDN，该架构下的转发设备在路由转发过程中不是基于传统的路由表匹配而是基于流表项匹配，而传统的开源DHCP中继技术方案都是基于路由表的转发方式，因此此处无法采用传统开源方案配置。由此我们选择自主设计相应的SDN控制器，由控制器对报文进行修改来实现我们预期的DHCP中继功能。</p><p>以S1所属的子网主机实现DHCP服务为例分析，在SDN网络中实现DHCP中继的IP地址分配/租赁过程思路如下：</p><ol><li>当h1发送DHCP Discover/Request报文时，会将DHCP Discover/Request报文广播发送到s1。</li><li>当s1收到DHCP Discover/Request报文后会将报文上发到SDN控制器处理。</li><li>当控制器收到s1上发的DHCP Discover/Request报文后，会查询所记录的s1对应的IP地址并替换报文中DHCP协议的giaddr字段；并修改以太网协议的源MAC为s1与二层交换机相连端口的MAC及目的MAC为所记录的DHCP服务器MAC地址（此处使用随机算法，随机选择DHCP服务器与s4、s5连接的其中一条链路发送，实现DHCP服务器的负载均衡）、IP协议的源IP为s1对应的IP地址及目的IP为DHCP中继服务器对应的IP地址；最终将修改完成的报文送往随机选定的DHCP服务器端口。</li><li>当DHCP服务器收到请求报文后，会在其预先配置的多个DHCP地址池中选择与报文中DHCP协议的giaddr字段对应的地址的地址池，并返回相应信息（IP信息、网关、租期等等）。</li><li>当s4或s5收到DHCP服务器发送的DHCP Offer/Reply报文时，会将该报文上发给控制器。</li><li>当控制器收到s4或s5上发的DHCP Offer/Reply报文后，会根据报文中DHCP协议的giaddr字段查询对应的DHCP中继代理交换机及该交换机与二层交换机连接的端口；并修改报文中以太网协议的源MAC为对应的DHCP中继代理交换机与二层交换机相连端口的MAC地址及目的MAC为所记录的DHCP服务器MAC地址、IP协议的源IP为对应的DHCP中继代理交换机与二层交换机相连端口的的IP地址及HCP协议的yiaddr字段；最终将修改完的报文从对应的DHCP中继代理交换机与二层交换机连接的端口送出，即送回原来的子网，完成DHCP服务的交互。</li></ol><p>对于IP地址更新流程和IP地址释放流程的思路与IP地址分配/租赁过程几乎一致，同样是将报文上发到控制器并修改报文，最终将报文发送到指定的位置实现DHCP服务。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230717204312586.png" alt="DHCP中继流程图"></p><h2 id="应用服务器设计">应用服务器设计</h2><p>（一）需求分析</p><p>在我们设计的网络中，为了更好为内部网络和外界提供服务，我们设置了一个服务器集群提供各种服务。其中设置了Web服务器用于提供门户网站、外界宣传等服务，设置FTP服务器用于为内部员工提供重要文件共享和传输服务。在Web服务器的搭建中，为了保障Web服务器的安全及实现负载均衡，我们使用了反向代理的机制，使用两台反向代理服务器用于代理Web服务器集群。</p><p>（二）设计思路</p><p>在我们设计的网络中，所有的主机和SDN交换机都是基于Mininet平台的虚拟设备，而对我们的服务器而言，为了更好的实现预期的服务功能，我们需要使用真实的虚拟机来配置。其中如何连接基于Mininet平台的拓扑和作为服务器的虚拟机是一个关键的问题。</p><p>针对这个问题，我们使用与课程实验平台类似的搭建方式，即在VMware中创建多个虚拟网络VMnet，并在Mininet拓扑所在的虚拟机中新建连接对应VMnet网络的网卡，将该网卡与拓扑中连接服务器的二层交换机连接，最终实现Mininet拓扑与真实虚拟机的联通。</p><p>其次是Web服务器的反向代理机制，我们在网络中配置了两个反向代理服务器及两个Web服务器用来模拟服务器集群。为了保障Web服务器的安全，我们设计由反向代理服务器与拓扑中的二层交换机连接，Web服务器只能反向代理服务器范围。对此我们需要在每个反向代理服务器配置两张网卡，一张用于连接拓扑中的二层交换机，另一张用于连接Web服务器；并在反向代理服务器中安装nginx，使用nginx的代理机制将特定IP地址（反向代理服务器的IP地址）的访问映射到我们指定的IP地址（Web服务器的IP地址）去，实现基于nginx的反向代理。同时可以配置代理映射地址池，将特定IP地址映射到指定的地址池中，按权重选择某一IP地址访问实现Web服务器的负载均衡。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230717204118106.png" alt="服务器搭建流程"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230717204134412.png" alt="服务器访问流程"></p><h2 id="基于vrrp协议的高可用设计">基于VRRP协议的高可用设计</h2><p>（一）需求分析</p><p>在我们设计的网络中，Web服务器的配置采用反向代理的机制，但当反向代理服务器出现异常时，就会出现Web服务器无法访问的情况。为了应对这种情况，我们使用了两台反向代理服务器做主备服务器。两台主机通过VRRP协议组成一个服务器组，虚拟化为一台反向代理服务器，拥有对应的虚拟IP地址，当一台服务器出现异常时，另一台服务器可以通过VRRP协议检测到异常，并接替另一台服务器的虚拟IP地址继续完成服务，保障服务器组高可用。</p><p>常见基于VRRP协议的高可用配置有主从配置和双主配置， 主从配置中两台反向代理服务器共用一个虚拟IP地址，同一时刻只有一台主服务器工作，另一台备份服务器在主服务器不出现故障的时候，永远处于浪费状态；双主配置中两台反向代理服务器互为主备服务器，同一时刻两台服务器都在工作，当其中一台服务器出现故障时，两台服务器的请求都转移到一台服务器负担。出于充分利用服务器性能及增加访问负载能力等角度考虑，最终决定在我们的网络中采用主从配置实现高可用。</p><p>（二）设计思路</p><p>对于VRRP协议高可用配置的使用，我们决定使用现成比较成熟的技术方案配置，即keepalived软件。我们使用keepalived软件将两台位于同一子网并连通的反向代理服务器组成一个反向代理服务器组，并配置两台服务器互为主备服务器，分别设置相应的优先级、检测时延等基础参数，最终实现两台反向代理服务器之间的高可用服务。</p><h2 id="gre隧道设计">GRE隧道设计</h2><p>（一）需求分析</p><p>在我们设计的网络中，我们搭建了主干网和分支网，其中主干网和分支网分别位于不同的物理网络。为了保障主干网中内部资源与分支网的共享还有通信的安全性，我们计划在主干网和分支网之间搭建一条GRE隧道用于两个网络的内部连通，即通过隧道连接分支网的主机设备与主干网的服务器集群。分支网的主机既可以通过公网IP访问Web服务器也可以通过GRE隧道访问Web服务器；但主机只能通过GRE隧道访问FTP服务器，以保障内部资料的安全。</p><p>（二）设计思路</p><p>在我们设计的网络中，主干网和分支网位于不同的虚拟机中，对于GRE隧道的实现，我们需要搭建一条连通两个虚拟机中Miniet拓扑的GRE隧道。因为Linux系统支持系统级的GRE隧道配置，因此我们只需要在两个虚拟机间搭建一条系统级的GRE隧道连通相应网段，将拓扑中NAT交换机配置为隧道站点，当收到相应隧道报文时，将报文从NAT交换机与隧道相连的端口送出即可完成Mininet拓扑之间隧道的通信。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230717204503922.png" alt="GRE隧道两端主机通信流程图"></p><h1 id="方案实现与结果分析">方案实现与结果分析</h1><h2 id="napt实现与分析">NAPT实现与分析</h2><p>（一）实现</p><details class="folding-tag" blue><summary>文本配置的读取并初始化控制器</summary><div class="content"><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230717210346850.png" alt="文本配置中NAPT相关信息"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 读取NAT信息</span></span><br><span class="line">self.nat_ip = content[<span class="number">0</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>).split(<span class="string">&#x27;=&#x27;</span>)[-<span class="number">1</span>].split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-----------------------NAt_ip:  &#123;&#125;---------------------&quot;</span>.<span class="built_in">format</span>(self.nat_ip))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取NAT mask信息</span></span><br><span class="line">self.nat_mask = content[<span class="number">0</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>).split(<span class="string">&#x27;=&#x27;</span>)[-<span class="number">1</span>].split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-----------------------NAt_mask:  &#123;&#125;---------------------&quot;</span>.<span class="built_in">format</span>(self.nat_mask))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取NAT交换机编号信息</span></span><br><span class="line">self.nat_switch_id = <span class="built_in">int</span>(content[<span class="number">1</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>).split(<span class="string">&#x27;=&#x27;</span>)[-<span class="number">1</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-----------------------NAt_ip:  &#123;&#125;---------------------&quot;</span>.<span class="built_in">format</span>(self.nat_switch_id))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取NAT交换机端口信息</span></span><br><span class="line">self.nat_switch_port = <span class="built_in">int</span>(content[<span class="number">2</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>).split(<span class="string">&#x27;=&#x27;</span>)[-<span class="number">1</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-----------------------NAt_ip:  &#123;&#125;---------------------&quot;</span>.<span class="built_in">format</span>(self.nat_switch_port))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取网络网关信息</span></span><br><span class="line">self.net_getaway_ip = content[<span class="number">3</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>).split(<span class="string">&#x27;=&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-----------------------NAt_ip:  &#123;&#125;---------------------&quot;</span>.<span class="built_in">format</span>(self.net_getaway_ip))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取网络信息</span></span><br><span class="line">self.net_ip = content[<span class="number">4</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>).split(<span class="string">&#x27;=&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-----------------------Net_ip:  &#123;&#125;---------------------&quot;</span>.<span class="built_in">format</span>(self.net_ip))</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></details><details class="folding-tag" blue><summary>服务器初始映射</summary><div class="content"><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230717210641557.png" alt="服务器初始映射"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 读取web 相关信息</span></span><br><span class="line">self.serve_host = content[<span class="number">9</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>).split(<span class="string">&#x27;=&#x27;</span>)[-<span class="number">1</span>].split(<span class="string">&#x27;;&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> self.serve_host:</span><br><span class="line">  self.tcp_out[(host.split(<span class="string">&#x27;,&#x27;</span>)[<span class="number">0</span>].split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">0</span>], <span class="built_in">int</span>(host.split(<span class="string">&#x27;,&#x27;</span>)[<span class="number">0</span>].split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">1</span>]))] = <span class="built_in">int</span>(host.split(<span class="string">&#x27;,&#x27;</span>)[<span class="number">1</span>])</span><br><span class="line">  self.tcp_in[<span class="built_in">int</span>(host.split(<span class="string">&#x27;,&#x27;</span>)[<span class="number">1</span>])] = (host.split(<span class="string">&#x27;,&#x27;</span>)[<span class="number">0</span>].split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">0</span>], <span class="built_in">int</span>(host.split(<span class="string">&#x27;,&#x27;</span>)[<span class="number">0</span>].split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">1</span>]))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-----------------------server_host:  &#123;&#125;---------------------&quot;</span>.<span class="built_in">format</span>(self.serve_host))</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></details><details class="folding-tag" blue><summary>向外网发送报文做NAPT</summary><div class="content"><p>当我们判断一个报文其目的地址为外网，源地址为内网的时候，他就是一个发往外网的报文，此时需要利用NAT_out函数进行处理。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">NAT_out</span>(<span class="params">self, msg</span>):</span><br><span class="line">        datapath = msg.datapath</span><br><span class="line">        in_port = msg.<span class="keyword">match</span>[<span class="string">&#x27;in_port&#x27;</span>]</span><br><span class="line">        pkt = packet.Packet(msg.data)</span><br><span class="line">        eth = pkt.get_protocols(ethernet.ethernet)[<span class="number">0</span>]</span><br><span class="line">        parser = self.nat_switch.dp.ofproto_parser</span><br><span class="line">        pkt_ipv4 = pkt.get_protocol(ipv4.ipv4)</span><br><span class="line">        pkt_udp = pkt.get_protocol(udp.udp)</span><br><span class="line">        pkt_tcp = pkt.get_protocol(tcp.tcp)</span><br><span class="line">        pkt_icmp = pkt.get_protocol(icmp.icmp)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pkt_icmp <span class="keyword">and</span> pkt_icmp.<span class="built_in">type</span> == icmp.ICMP_ECHO_REQUEST:</span><br><span class="line">            <span class="comment"># 找到icmp未有记录</span></span><br><span class="line">            <span class="keyword">if</span> (pkt_ipv4.src, pkt_icmp.data.<span class="built_in">id</span>) <span class="keyword">not</span> <span class="keyword">in</span> self.icmp_out:</span><br><span class="line">                icmp_id = copy.copy(pkt_icmp.data.<span class="built_in">id</span>)</span><br><span class="line">                <span class="comment"># 使得变换后icmp不冲突</span></span><br><span class="line">                <span class="keyword">while</span> icmp_id <span class="keyword">in</span> self.icmp_in:</span><br><span class="line">                    icmp_id += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                self.icmp_out[(pkt_ipv4.src, pkt_icmp.data.<span class="built_in">id</span>)] = icmp_id</span><br><span class="line">                self.icmp_in[icmp_id] = (pkt_ipv4.src, pkt_icmp.data.<span class="built_in">id</span>)</span><br><span class="line">                self.ICMPTTLinit(icmp_id)</span><br><span class="line"></span><br><span class="line">            src_ip = copy.copy(pkt_ipv4.src)</span><br><span class="line">            actions = [parser.OFPActionOutput(self.nat_switch_port)]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 修改mac</span></span><br><span class="line">            <span class="keyword">if</span> self.net_getaway_ip <span class="keyword">in</span> self.arp_table <span class="keyword">and</span> <span class="keyword">not</span> (</span><br><span class="line">                    self.ipInSubnet(pkt_ipv4.dst, <span class="string">&quot;/&quot;</span>.join((self.nat_ip, self.nat_mask)))):</span><br><span class="line">                eth.dst = self.arp_table[self.net_getaway_ip][<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">elif</span> pkt_ipv4.dst <span class="keyword">in</span> self.arp_table:</span><br><span class="line">                eth.dst = self.arp_table[pkt_ipv4.dst][<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.stor(msg)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            src_id = pkt_icmp.data.<span class="built_in">id</span></span><br><span class="line">            <span class="comment"># 修改id</span></span><br><span class="line">            pkt_icmp.data.<span class="built_in">id</span> = self.icmp_out[(src_ip, pkt_icmp.data.<span class="built_in">id</span>)]</span><br><span class="line">            self.ICMPTTLinit(pkt_icmp.data.<span class="built_in">id</span>)</span><br><span class="line">            <span class="comment"># 修改原ip</span></span><br><span class="line">            pkt_ipv4.src = self.nat_ip</span><br><span class="line">            self.logger.info(</span><br><span class="line">                <span class="string">&quot;send a ICMP Packet to internet changed_ip is from &#123;&#125; id:&#123;&#125; to &#123;&#125; SNAT to &#123;&#125; id:&#123;&#125;\n&quot;</span>.<span class="built_in">format</span>(src_ip,src_id, pkt_ipv4.src,self.nat_ip,pkt_icmp.data.<span class="built_in">id</span>))</span><br><span class="line">            pkt_icmp.csum = <span class="number">0</span></span><br><span class="line">            pkt.serialize()</span><br><span class="line">            self.send_out(self.nat_switch, actions, pkt.data)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> pkt_tcp:</span><br><span class="line">            <span class="comment"># 找到icmp未有记录</span></span><br><span class="line">            src_port = copy.copy(pkt_tcp.src_port)</span><br><span class="line">            <span class="keyword">if</span> (pkt_ipv4.src, pkt_tcp.src_port) <span class="keyword">not</span> <span class="keyword">in</span> self.tcp_out:</span><br><span class="line">                <span class="comment"># 使得变换后icmp不冲突</span></span><br><span class="line">                <span class="keyword">while</span> src_port <span class="keyword">in</span> self.tcp_in:</span><br><span class="line">                    src_port += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                self.tcp_out[(pkt_ipv4.src, pkt_tcp.src_port)] = src_port</span><br><span class="line">                self.tcp_in[src_port] = (pkt_ipv4.src, pkt_tcp.src_port)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># sleep(1)</span></span><br><span class="line">            src_ip = copy.copy(pkt_ipv4.src)</span><br><span class="line">            actions = [parser.OFPActionOutput(self.nat_switch_port)]</span><br><span class="line">            origin_mac = eth.dst</span><br><span class="line">            <span class="comment"># 修改mac</span></span><br><span class="line">            <span class="keyword">if</span> self.net_getaway_ip <span class="keyword">in</span> self.arp_table <span class="keyword">and</span> <span class="keyword">not</span> (</span><br><span class="line">                    self.ipInSubnet(pkt_ipv4.dst, <span class="string">&quot;/&quot;</span>.join((self.nat_ip, self.nat_mask)))):</span><br><span class="line">                eth.dst = self.arp_table[self.net_getaway_ip][<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">elif</span> pkt_ipv4.dst <span class="keyword">in</span> self.arp_table:</span><br><span class="line">                eth.dst = self.arp_table[pkt_ipv4.dst][<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.stor(msg)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 修改port</span></span><br><span class="line">            pkt_tcp.src_port = self.tcp_out[(src_ip, pkt_tcp.src_port)]</span><br><span class="line">            <span class="comment"># 修改原ip</span></span><br><span class="line">            pkt_ipv4.src = self.nat_ip</span><br><span class="line">            self.logger.info(</span><br><span class="line">                <span class="string">&quot;send a TCP Packet to internet changed_ip is from &#123;&#125;:&#123;&#125; to &#123;&#125;:&#123;&#125; SNAT to &#123;&#125;:&#123;&#125;\n&quot;</span>.<span class="built_in">format</span>(src_ip, src_port, pkt_ipv4.dst,</span><br><span class="line">                                                                            pkt_tcp.dst_port, pkt_ipv4.src,pkt_tcp.src_port))</span><br><span class="line">            pkt_tcp.csum = <span class="number">0</span></span><br><span class="line">            pkt.serialize()</span><br><span class="line">            self.send_out(self.nat_switch, actions, pkt.data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> pkt_udp:</span><br><span class="line">            <span class="comment"># 找到icmp未有记录</span></span><br><span class="line">            src_port = copy.copy(pkt_udp.src_port)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pkt_ipv4.src, pkt_udp.src_port) <span class="keyword">not</span> <span class="keyword">in</span> self.udp_out:</span><br><span class="line">                <span class="comment"># 使得变换后icmp不冲突</span></span><br><span class="line">                <span class="keyword">while</span> src_port <span class="keyword">in</span> self.udp_in:</span><br><span class="line">                    src_port += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                self.udp_out[(pkt_ipv4.src, pkt_udp.src_port)] = src_port</span><br><span class="line">                self.udp_in[src_port] = (pkt_ipv4.src, pkt_udp.src_port)</span><br><span class="line"></span><br><span class="line">            src_ip = copy.copy(pkt_ipv4.src)</span><br><span class="line">            actions = [parser.OFPActionOutput(self.nat_switch_port)]</span><br><span class="line">            origin_mac = eth.dst</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 修改mac</span></span><br><span class="line">            <span class="keyword">if</span> self.net_getaway_ip <span class="keyword">in</span> self.arp_table <span class="keyword">and</span> <span class="keyword">not</span> (</span><br><span class="line">                    self.ipInSubnet(pkt_ipv4.dst, <span class="string">&quot;/&quot;</span>.join((self.nat_ip, self.nat_mask)))):</span><br><span class="line">                eth.dst = self.arp_table[self.net_getaway_ip][<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">elif</span> pkt_ipv4.dst <span class="keyword">in</span> self.arp_table:</span><br><span class="line">                eth.dst = self.arp_table[pkt_ipv4.dst][<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.stor(msg)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="comment"># 修改id</span></span><br><span class="line">            pkt_udp.src_port = self.udp_out[(src_ip, pkt_udp.src_port)]</span><br><span class="line">            <span class="comment"># 修改原ip</span></span><br><span class="line">            pkt_ipv4.src = self.nat_ip</span><br><span class="line">            self.logger.info(</span><br><span class="line">                <span class="string">&quot;send to internet changed_ip is from &#123;&#125;:&#123;&#125; to &#123;&#125;:&#123;&#125; SNAT to &#123;&#125;:&#123;&#125;\n&quot;</span>.<span class="built_in">format</span>(src_ip, src_port, pkt_ipv4.dst,</span><br><span class="line">                                                                            pkt_udp.dst_port,self.nat_ip,pkt_udp.src_port))</span><br><span class="line">            pkt_udp.csum = <span class="number">0</span></span><br><span class="line">            pkt.serialize()</span><br><span class="line">            self.send_out(self.nat_switch, actions, pkt.data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="comment"># 找路</span></span><br><span class="line">        shortest_path = self.topo.Dijkstra(</span><br><span class="line">            datapath.<span class="built_in">id</span>, self.nat_switch_id, in_port, self.nat_switch_port</span><br><span class="line">        )                                                               <span class="built_in">len</span>(shortest_path)))</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(shortest_path) &gt; <span class="number">0</span></span><br><span class="line">        path_str = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> s, ip, op <span class="keyword">in</span> shortest_path:</span><br><span class="line">            path_str = path_str + <span class="string">&quot;--&#123;&#125;-&#123;&#125;-&#123;&#125;--&quot;</span>.<span class="built_in">format</span>(ip, s, op)</span><br><span class="line">        self.logger.info(<span class="string">&quot;Configure the shortset path from &#123;&#125; to &#123;&#125; —— &#123;&#125;\n&quot;</span>.<span class="built_in">format</span>(src_ip, pkt_ipv4.dst, path_str))</span><br><span class="line">        self.configure_path(shortest_path, msg, origin_mac, eth.dst, pkt_ipv4.dst)</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></details><details class="folding-tag" blue><summary>内网接收外网发送的报文做NAPT</summary><div class="content"><p>当我们判断一个报文其目的地址为外网，源地址也是外网的时候，他就可能是一个外网发往内网的报文，此时需要利用NAT_in函数进行处理，当他在映射表中有记录的时候，那么就进行处理。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">NAT_in</span>(<span class="params">self, msg</span>):</span><br><span class="line">       datapath = msg.datapath</span><br><span class="line">       in_port = msg.<span class="keyword">match</span>[<span class="string">&#x27;in_port&#x27;</span>]</span><br><span class="line">       pkt = packet.Packet(msg.data)</span><br><span class="line">       eth = pkt.get_protocols(ethernet.ethernet)[<span class="number">0</span>]</span><br><span class="line">       parser = self.nat_switch.dp.ofproto_parser</span><br><span class="line">       pkt_ipv4 = pkt.get_protocol(ipv4.ipv4)</span><br><span class="line">       pkt_udp = pkt.get_protocol(udp.udp)</span><br><span class="line">       pkt_tcp = pkt.get_protocol(tcp.tcp)</span><br><span class="line">       pkt_icmp = pkt.get_protocol(icmp.icmp)</span><br><span class="line">       <span class="keyword">if</span> pkt_icmp <span class="keyword">and</span> pkt_icmp.<span class="built_in">type</span> == icmp.ICMP_ECHO_REQUEST <span class="keyword">and</span> pkt_ipv4.dst==self.nat_ip:</span><br><span class="line">           icmp_reply = packet.Packet()</span><br><span class="line">           echo = pkt_icmp.data</span><br><span class="line">           echo.data = <span class="built_in">bytearray</span>(echo.data)</span><br><span class="line">           icmp_reply.add_protocol(ethernet.ethernet(</span><br><span class="line">               ethertype=ether.ETH_TYPE_IP,</span><br><span class="line">               dst=eth.src,</span><br><span class="line">               src=self.switch_adds[(self.nat_switch_id, self.nat_switch_port)]))</span><br><span class="line">           icmp_reply.add_protocol(ipv4.ipv4(version=<span class="number">4</span>, header_length=<span class="number">5</span>, tos=<span class="number">0</span>, total_length=<span class="number">84</span>,</span><br><span class="line">                      identification=<span class="number">0</span>, flags=<span class="number">0</span>, offset=<span class="number">0</span>, ttl=<span class="number">64</span>,</span><br><span class="line">                      proto=inet.IPPROTO_ICMP, csum=<span class="number">0</span>,</span><br><span class="line">                      src=self.nat_ip, dst=pkt_ipv4.src))</span><br><span class="line">           icmp_reply.add_protocol(icmp.icmp(icmp.ICMP_ECHO_REPLY, code=<span class="number">0</span>, csum=<span class="number">0</span>, data=echo))</span><br><span class="line">           icmp_reply.serialize()</span><br><span class="line">           actions = [parser.OFPActionOutput(in_port)]</span><br><span class="line">           out = parser.OFPPacketOut(</span><br><span class="line">               datapath=self.nat_switch.dp,</span><br><span class="line">               buffer_id=self.nat_switch.dp.ofproto.OFP_NO_BUFFER,</span><br><span class="line">               in_port=self.nat_switch.dp.ofproto.OFPP_CONTROLLER,</span><br><span class="line">               actions=actions, data=icmp_reply.data)</span><br><span class="line">           self.nat_switch.dp.send_msg(out)</span><br><span class="line">           <span class="keyword">return</span></span><br><span class="line">       <span class="comment"># icmp</span></span><br><span class="line">       <span class="keyword">elif</span> pkt_icmp <span class="keyword">and</span> pkt_icmp.<span class="built_in">type</span> == icmp.ICMP_ECHO_REPLY:</span><br><span class="line">           <span class="comment"># 找到icmp未有记录</span></span><br><span class="line">           <span class="keyword">if</span> pkt_icmp.data.<span class="built_in">id</span> <span class="keyword">in</span> self.icmp_in:</span><br><span class="line"></span><br><span class="line">               <span class="comment"># 来个icmp报文就便利寿命减一</span></span><br><span class="line">               self.ICMPTTLdes()</span><br><span class="line"></span><br><span class="line">               dst_ip = pkt_ipv4.dst</span><br><span class="line">               dst_id = pkt_icmp.data.<span class="built_in">id</span></span><br><span class="line">               pkt_ipv4.dst = self.icmp_in[pkt_icmp.data.<span class="built_in">id</span>][<span class="number">0</span>]</span><br><span class="line">               pkt_icmp.data.<span class="built_in">id</span> = self.icmp_in[pkt_icmp.data.<span class="built_in">id</span>][<span class="number">1</span>]</span><br><span class="line">               pkt_icmp.csum = <span class="number">0</span></span><br><span class="line">               <span class="comment"># print(&quot;Change origin dst IP to &#123;&#125;&quot;.format(pkt_ipv4.dst))</span></span><br><span class="line">               pkt.serialize()</span><br><span class="line">               msg.data = pkt.data</span><br><span class="line">               <span class="comment"># 找出在一个子网的有主机边缘交换机及mac</span></span><br><span class="line">               self.logger.info(</span><br><span class="line">                   <span class="string">&quot;Received a ICMP Packet to our network from internet &#123;&#125; to &#123;&#125; id:&#123;&#125; DNAT to &#123;&#125; id:&#123;&#125; \n&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                       pkt_ipv4.src,dst_ip,dst_id,pkt_ipv4.dst,pkt_icmp.data.<span class="built_in">id</span>))</span><br><span class="line">               <span class="keyword">if</span> self.find(pkt_ipv4.dst):</span><br><span class="line">                   dst_mac, dst_switch_id, final_port = self.arp_table[pkt_ipv4.dst]</span><br><span class="line">                   <span class="comment"># print(&quot;find switch &#123;&#125; port &#123;&#125; &quot;.format(dst_switch_id, final_port))</span></span><br><span class="line">                   eth.dst = dst_mac</span><br><span class="line">                   actions = [parser.OFPActionOutput(final_port)]</span><br><span class="line">                   dst_switch = copy.copy(get_switch(self, dst_switch_id))[<span class="number">0</span>]</span><br><span class="line">                   pkt.serialize()</span><br><span class="line">                   out = parser.OFPPacketOut(</span><br><span class="line">                       datapath=dst_switch.dp,</span><br><span class="line">                       buffer_id=dst_switch.dp.ofproto.OFP_NO_BUFFER,</span><br><span class="line">                       in_port=dst_switch.dp.ofproto.OFPP_CONTROLLER,</span><br><span class="line">                       actions=actions, data=pkt.data)</span><br><span class="line">                   dst_switch.dp.send_msg(out)</span><br><span class="line">               <span class="keyword">else</span>:</span><br><span class="line">                   self.stor(msg)</span><br><span class="line">           <span class="keyword">return</span></span><br><span class="line">       <span class="comment"># tcp</span></span><br><span class="line">       <span class="keyword">elif</span> pkt_tcp:</span><br><span class="line">           <span class="comment"># 找到tcpp未有记录</span></span><br><span class="line">           <span class="keyword">if</span> pkt_tcp.dst_port <span class="keyword">in</span> self.tcp_in:</span><br><span class="line">               <span class="comment"># self.logger.info(</span></span><br><span class="line">               <span class="comment">#     &quot;----------------Received a packet to our network from internet2 , src_ip: &#123;&#125;   -----------------------------&quot;.format(</span></span><br><span class="line">               <span class="comment">#         pkt_ipv4.src))</span></span><br><span class="line">               dst_ip = pkt_ipv4.dst</span><br><span class="line">               dst_port = pkt_tcp.dst_port</span><br><span class="line">               pkt_ipv4.dst = self.tcp_in[pkt_tcp.dst_port][<span class="number">0</span>]</span><br><span class="line">               pkt_tcp.dst_port = self.tcp_in[pkt_tcp.dst_port][<span class="number">1</span>]</span><br><span class="line">               pkt_tcp.csum = <span class="number">0</span></span><br><span class="line">               <span class="comment"># print(&quot;Change origin dst IP to &#123;&#125;&quot;.format(pkt_ipv4.dst))</span></span><br><span class="line">               pkt.serialize()</span><br><span class="line">               msg.data = pkt.data</span><br><span class="line">               self.logger.info(</span><br><span class="line">                   <span class="string">&quot;Received a TCP Packet to our network from internet &#123;&#125;:&#123;&#125; to &#123;&#125;:&#123;&#125; DNAT to &#123;&#125;:&#123;&#125; \n&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                       pkt_ipv4.src,pkt_tcp.src_port,dst_ip,dst_port,pkt_ipv4.dst,pkt_tcp.dst_port))</span><br><span class="line">               <span class="comment"># 找出在一个子网的有主机边缘交换机及mac</span></span><br><span class="line">               <span class="keyword">if</span> self.find(pkt_ipv4.dst):</span><br><span class="line">                   <span class="comment"># print(self.arp_table)</span></span><br><span class="line">                   dst_mac, dst_switch_id, final_port = self.arp_table[pkt_ipv4.dst]</span><br><span class="line">                   <span class="comment"># print(&quot;find switch &#123;&#125; port &#123;&#125; &quot;.format(dst_switch_id, final_port))</span></span><br><span class="line">                   eth.dst = dst_mac</span><br><span class="line">                   <span class="comment"># print(eth.dst)</span></span><br><span class="line">                   actions = [parser.OFPActionOutput(final_port)]</span><br><span class="line">                   pkt.serialize()</span><br><span class="line"></span><br><span class="line">                   dst_switch = copy.copy(get_switch(self, dst_switch_id))[<span class="number">0</span>]</span><br><span class="line">                   out = parser.OFPPacketOut(</span><br><span class="line">                       datapath=dst_switch.dp,</span><br><span class="line">                       buffer_id=dst_switch.dp.ofproto.OFP_NO_BUFFER,</span><br><span class="line">                       in_port=dst_switch.dp.ofproto.OFPP_CONTROLLER,</span><br><span class="line">                       actions=actions, data=pkt.data)</span><br><span class="line">                   dst_switch.dp.send_msg(out)</span><br><span class="line">               <span class="keyword">else</span>:</span><br><span class="line">                   self.stor(msg)</span><br><span class="line">                   <span class="keyword">return</span></span><br><span class="line">           <span class="keyword">else</span>:</span><br><span class="line">               <span class="keyword">return</span></span><br><span class="line">       <span class="comment"># udp</span></span><br><span class="line">       <span class="keyword">elif</span> pkt_udp:</span><br><span class="line">           <span class="comment"># 找到udp未有记录</span></span><br><span class="line">           <span class="keyword">if</span> pkt_udp.dst_port <span class="keyword">in</span> self.udp_in:</span><br><span class="line">               dst_ip = pkt_ipv4.dst</span><br><span class="line">               dst_port = pkt_udp.dst_port</span><br><span class="line">               pkt_ipv4.dst = self.udp_in[pkt_udp.dst_port][<span class="number">0</span>]</span><br><span class="line">               pkt_udp.dst_port = self.udp_in[pkt_udp.dst_port][<span class="number">1</span>]</span><br><span class="line">               pkt_udp.csum = <span class="number">0</span></span><br><span class="line">               pkt.serialize()</span><br><span class="line">               msg.data = pkt.data</span><br><span class="line">               <span class="comment"># 找出在一个子网的有主机边缘交换机及mac</span></span><br><span class="line">               self.logger.info(</span><br><span class="line">                   <span class="string">&quot;Received a UDP Packet to our network from internet &#123;&#125;:&#123;&#125; to &#123;&#125;:&#123;&#125;  DNAT to &#123;&#125;:&#123;&#125;\n&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                       pkt_ipv4.src,pkt_udp.src_port,dst_ip,dst_port,pkt_ipv4.dst,pkt_udp.dst_port))</span><br><span class="line">               <span class="keyword">if</span> self.find(pkt_ipv4.dst):</span><br><span class="line">                   dst_mac, dst_switch_id, final_port = self.arp_table[pkt_ipv4.dst]</span><br><span class="line">                   eth.dst = dst_mac</span><br><span class="line">                   actions = [parser.OFPActionOutput(final_port)]</span><br><span class="line">                   dst_switch = copy.copy(get_switch(self, dst_switch_id))[<span class="number">0</span>]</span><br><span class="line">                   pkt.serialize()</span><br><span class="line">                   out = parser.OFPPacketOut(</span><br><span class="line">                       datapath=dst_switch.dp,</span><br><span class="line">                       buffer_id=dst_switch.dp.ofproto.OFP_NO_BUFFER,</span><br><span class="line">                       in_port=dst_switch.dp.ofproto.OFPP_CONTROLLER,</span><br><span class="line">                       actions=actions, data=pkt.data)</span><br><span class="line">                   dst_switch.dp.send_msg(out)</span><br><span class="line">               <span class="keyword">else</span>:</span><br><span class="line">                   self.stor(msg)</span><br><span class="line">                   <span class="keyword">return</span></span><br><span class="line">           <span class="keyword">else</span>:</span><br><span class="line">               <span class="keyword">return</span></span><br><span class="line">       <span class="keyword">else</span>:</span><br><span class="line">           <span class="keyword">return</span></span><br><span class="line">           <span class="comment"># 找路</span></span><br><span class="line">       shortest_path = self.topo.Dijkstra(</span><br><span class="line">           datapath.<span class="built_in">id</span>, dst_switch.dp.<span class="built_in">id</span>, in_port, final_port</span><br><span class="line">       )</span><br><span class="line">       <span class="keyword">assert</span> <span class="built_in">len</span>(shortest_path) &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line">       path_str = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">       <span class="comment"># (s1,inport,outport)-&gt;(s2,inport,outport)-&gt;...-&gt;(dest_switch,inport,outport)</span></span><br><span class="line">       <span class="keyword">for</span> s, ip, op <span class="keyword">in</span> shortest_path:</span><br><span class="line">           path_str = path_str + <span class="string">&quot;--&#123;&#125;-&#123;&#125;-&#123;&#125;--&quot;</span>.<span class="built_in">format</span>(ip, s, op)</span><br><span class="line">       self.logger.info(<span class="string">&quot;Configure the shortset path from &#123;&#125; to &#123;&#125; —— &#123;&#125;\n&quot;</span>.<span class="built_in">format</span>(pkt_ipv4.src, pkt_ipv4.dst, path_str))</span><br><span class="line"></span><br><span class="line">       self.configure_path(shortest_path, msg, <span class="literal">None</span>, eth.dst, self.nat_ip)</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></details><p>（二）结果分析</p><ul><li><p>ICMP</p><p>我们分别用h1与h2去ping www.baidu.com可以发现都能够成功ping通。此时查看抓包结果发现两次ping源IP是相同的，均是192.168.31.89。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718115335870.png" alt="抓包"></p><p>不同的地方在于两者的identifier。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718115413536.png" alt="二者具体报文"></p><p>说明可以用不同的标识进行区分而用同一个ip实现对外网（baidu）的访问。</p></li><li><p>TCP与UDP</p><p>这里我们使用h1打开Google，通过Google访问4399小游戏网站，可以发现我们能对该网站进行正常的访问与操作。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718115701784.png" alt="网站访问"></p><p>查看流表可以发现s7作为NAPT访问的一个节点，将源ip与端口转化为对应的NAPT的ip与端口的报文来通过下发流表的方式实现NAPT。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718120403787.png" alt="流表"></p><p>同时从抓包分析中也可以看到，从192.168.31.89返回的不同包中端口是不同的，也可以证明我们tcp和udp的NAPT操作正确。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718120431947.png" alt="抓包分析"></p></li></ul><h2 id="防火墙实现与分析">防火墙实现与分析</h2><p>（一）实现</p><details class="folding-tag" blue><summary>防火墙指令</summary><div class="content"><p>在mininet的拓扑环境搭建完毕后，建立一个新的xterm来操作专用于防火墙的controller。</p><p><code>xterm c0</code></p><p>然后在switch的xterm上将OpenFlow版本设定为1.3。</p><p><code>ovs-vsctl set Bridge s1 protocols=OpenFlow13</code></p><p>最后在controller的xterm上启动rest_firewall。</p><p><code>ryu-manager ryu.app.rest_firewall</code></p><p>防火墙启动后默认为全部网络无法连接的状态，我们首先使防火墙生效。</p><p><code>curl -X PUT http://localhost:8080/firewall/module/enable/0000000000000009</code></p><p>启动完毕后对防火墙的规则进行设定：</p><p><code>curl -X POST -d'{&quot;nw_src&quot;:&quot;192.168.4.0/24&quot;}' http://0.0.0.0:8080/firewall/rules/0000000000000009</code></p><p>//允许所有源IP为<code>192.168.4.0</code>的报文通过</p><p><code>curl -X POST -d '{&quot;nw_dst&quot;: &quot;192.168.4.200/32&quot;, &quot;tcp_dst&quot;:&quot;8O&quot;}' http://0.0.0.0:8080/firewall/rules/0000000000000009</code></p><p><code>curl -X POST -d '{&quot;nw_dst&quot;: &quot;192.168.4.210/32&quot;, &quot;tcp_dst&quot;:&quot;8O&quot;}' http://0.0.0.0:8080/firewall/rules/0000000000000009</code></p><p>//允许所有目的IP为Web服务器，目的端口为80的报文通过</p><p><code>curl -X POST -d '{&quot;nw_proto&quot;: &quot;ICMP&quot;, &quot;actions&quot;: &quot;DENY&quot;, &quot;priority&quot;: &quot;2&quot;}' http://0.0.0.0:8080/firewall/rules/0000000000000009</code></p><p>//禁止ICMP报文通过对服务器造成负担</p><p><code>curl -X POST -d '{&quot;nw_src&quot;: &quot;192.168,1.0/24&quot;,&quot;nw_dst&quot;:&quot;192.168.4.5/32&quot;}’ http://0.0.0.0:8080/firewall/rules/0000000000000009</code></p><p><code>curl -X POST -d '{&quot;nw_src&quot;: &quot;192.168,2.0/24&quot;,&quot;nw_dst&quot;:&quot;192.168.4.5/32&quot;}’ http://0.0.0.0:8080/firewall/rules/0000000000000009</code></p><p><code>curl -X POST -d '{&quot;nw_src&quot;: &quot;192.168,6.0/24&quot;,&quot;nw_dst&quot;:&quot;192.168.4.5/32&quot;}’ http://0.0,0.0:8080/firewall/rules/0000000000000009</code></p><p>//只允许部分内部网络访问FTP服务器 访客网络禁止访问FTP服务器</p></div></details><p>（二）结果分析</p><ul><li><p>启动前</p><p>在防火墙启动之前h1可以正常ping通web服务器和ftp服务器。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718120616963.png" alt="ping通展示"></p></li><li><p>启动后</p><p>由于我们的防火墙是基于流表项的防火墙，因此通过查看流表项可以发现s11（防火墙）已经存在我们添加的规则流表项。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718120737067.png" alt="流表项"></p></li><li><p>内网测试</p><p>此时h1再次ping web服务器与ftp服务器，发现无法ping通。这是因为我们设置了禁止转发icmp报文所致。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718120829951.png" alt="ping不通展示"></p><p>再通过h1去访问web服务器与ftp服务器发现可以正常访问。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718120924574.png" alt="正常访问服务器应用"></p></li><li><p>外网测试</p><p>然后打开h9（访客网络）的终端对ftp服务器进行访问，发现访问正常。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718121016966.png" alt="正常访问FTP服务器"></p><p>再用h9访问ftp服务器发现无法访问，因此可以证明我们的防火墙功能正常。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718121105021.png" alt="已无法访问FTP服务器"></p></li></ul><h2 id="dhcp中继实现与分析">DHCP中继实现与分析</h2><p>（一）实现</p><details class="folding-tag" blue><summary>DHCP相关配置</summary><div class="content"><p>在DHCP服务器的搭建中，我们先在Ubuntu中安装DHCP Server，即执行指令pip install dhcp。在安装完成并检测安装成功后，紧接着我们在etc/dhcp/dhcpd.conf文件中进行DHCP服务的相关配置。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">subnet <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span> netmask <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> &#123;</span><br><span class="line">   <span class="built_in">range</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.2</span>  <span class="number">192.168</span><span class="number">.1</span><span class="number">.253</span>;</span><br><span class="line">   option routers <span class="number">192.168</span><span class="number">.1</span><span class="number">.254</span>;</span><br><span class="line">   default-lease-time <span class="number">6000</span>;</span><br><span class="line">   <span class="built_in">max</span>-lease-time <span class="number">72000</span>;</span><br><span class="line">   INTERFACES = <span class="string">&quot;dhcp-eth1 dhcp-eth2&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">// <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span>网络的地址池，范围为<span class="number">192.168</span><span class="number">.1</span><span class="number">.2</span>-<span class="number">192.168</span><span class="number">.1</span><span class="number">.253</span>，网关为<span class="number">192.168</span><span class="number">.1</span><span class="number">.254</span>，默认地址释放时间为6000s，最大释放时间为720000s，绑定接口为dhcp-eth1和dhcp-eth2。</span><br><span class="line"></span><br><span class="line">subnet <span class="number">192.168</span><span class="number">.2</span><span class="number">.0</span> netmask <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> &#123;</span><br><span class="line">   <span class="built_in">range</span> <span class="number">192.168</span><span class="number">.2</span><span class="number">.2</span>  <span class="number">192.168</span><span class="number">.2</span><span class="number">.253</span>;</span><br><span class="line">   option routers <span class="number">192.168</span><span class="number">.2</span><span class="number">.254</span>;</span><br><span class="line">   default-lease-time <span class="number">6000</span>;</span><br><span class="line">   <span class="built_in">max</span>-lease-time <span class="number">72000</span>;</span><br><span class="line">   INTERFACES = <span class="string">&quot;dhcp-eth1 dhcp-eth2&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">// <span class="number">192.168</span><span class="number">.2</span><span class="number">.0</span>/<span class="number">24</span>网络的地址池，范围为<span class="number">192.168</span><span class="number">.2</span><span class="number">.2</span>-<span class="number">192.168</span><span class="number">.2</span><span class="number">.253</span>，网关为<span class="number">192.168</span><span class="number">.2</span><span class="number">.254</span>，默认地址释放时间为6000s，最大释放时间为720000s，绑定接口为dhcp-eth1和dhcp-eth2。</span><br><span class="line"></span><br><span class="line">subnet <span class="number">192.168</span><span class="number">.3</span><span class="number">.0</span> netmask <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> &#123;</span><br><span class="line">   <span class="built_in">range</span> <span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>  <span class="number">192.168</span><span class="number">.3</span><span class="number">.253</span>;</span><br><span class="line">   option routers <span class="number">192.168</span><span class="number">.3</span><span class="number">.254</span>;</span><br><span class="line">   default-lease-time <span class="number">6000</span>;</span><br><span class="line">   <span class="built_in">max</span>-lease-time <span class="number">72000</span>;</span><br><span class="line">   INTERFACES = <span class="string">&quot;dhcp-eth1 dhcp-eth2&quot;</span>; </span><br><span class="line">&#125;</span><br><span class="line">// <span class="number">192.168</span><span class="number">.3</span><span class="number">.0</span>/<span class="number">24</span>网络的地址池，范围为<span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>-<span class="number">192.168</span><span class="number">.3</span><span class="number">.253</span>，网关为<span class="number">192.168</span><span class="number">.3</span><span class="number">.254</span>，默认地址释放时间为6000s，最大释放时间为720000s，绑定接口为dhcp-eth1和dhcp-eth2。</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></details><details class="folding-tag" blue><summary>Mininet拓扑连接</summary><div class="content"><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230717224437206.png" alt="主干网拓扑图"></p><p>如主干网拓扑图所示，我们将s8 dhcp作为网络中DHCP服务器，并将该交换机的dhcp-eth1端口与s4交换机相连，设置该端口IP为192.168.0.1；dhcp-eth2端口与s5交换机相连，设置该端口IP为192.168.0.2，以此作为冗余链路，负载均衡的同时保障网络的健壮性。其次我们将拓扑中的s1、s2、s3交换机指定为DHCP中继代理交换机，将s1-eth1端口与二层交换机s8相连，设置该端口IP为192.168.1.254；将s1-eth1端口与二层交换机s9相连，设置该端口IP为192.168.2.254；将s3-eth1端口与二层交换机s10相连，设置该端口IP为192.168.3.254。</p></div></details><details class="folding-tag" blue><summary>相关信息的导入RYU</summary><div class="content"><p>通过文件配置读取的形式向控制器导入DHCP的相关信息。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230717224516873.png" alt="文本配置中DHCP相关信息"></p><p>编写代码实现文本配置的读取并初始化控制器。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 读取DHCP IP地址</span></span><br><span class="line">self.dhcp_ip = content[<span class="number">6</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>).split(<span class="string">&#x27;=&#x27;</span>)[-<span class="number">1</span>].split(<span class="string">&#x27;;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-----------------------DHCP_IP:  &#123;&#125;---------------------&quot;</span>.<span class="built_in">format</span>(self.dhcp_ip))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取DHCP switch 相关信息</span></span><br><span class="line">self.dhcp_switch = <span class="built_in">int</span>(content[<span class="number">7</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>).split(<span class="string">&#x27;=&#x27;</span>)[-<span class="number">1</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-----------------------DHCP_Switch:  &#123;&#125;---------------------&quot;</span>.<span class="built_in">format</span>(self.dhcp_switch))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取DHCP 中继相关信息</span></span><br><span class="line">dhcp_relay_str = content[<span class="number">8</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>).split(<span class="string">&#x27;=&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> dhcp_relay_str.split(<span class="string">&#x27;;&#x27;</span>):</span><br><span class="line">    self.dhcp_relay.append((<span class="built_in">int</span>(item.split(<span class="string">&#x27;,&#x27;</span>)[<span class="number">0</span>]), <span class="built_in">int</span>(item.split(<span class="string">&#x27;,&#x27;</span>)[<span class="number">1</span>]), item.split(<span class="string">&#x27;,&#x27;</span>)[<span class="number">2</span>]))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-----------------------DHCP_Relay:  &#123;&#125;---------------------&quot;</span>.<span class="built_in">format</span>(self.dhcp_relay))</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></details><details class="folding-tag" blue><summary>RYU报文的获取及初步处理</summary><div class="content"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 读取报文DHCP协议信息</span></span><br><span class="line">pkt_dhcp = pkt.get_protocol(dhcp.dhcp)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断是否为DHCP报文</span></span><br><span class="line"><span class="keyword">if</span> pkt_dhcp:</span><br><span class="line">    <span class="comment"># 判断上发该报文交换机ID是否为DHCP服务器 若是则丢弃 不是则进行DHCP中继处理</span></span><br><span class="line">    <span class="keyword">if</span> dpid != self.dhcp_switch:</span><br><span class="line">        self.dhcp_relay_handler(msg)</span><br><span class="line">    <span class="keyword">return</span></span><br></pre></td></tr></table></figure></div></details><details class="folding-tag" blue><summary>RYU对DHCP报文解析</summary><div class="content"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 读取上发该报文的交换机ID和端口号</span></span><br><span class="line">dpid = msg.datapath.<span class="built_in">id</span></span><br><span class="line">in_port = msg.<span class="keyword">match</span>[<span class="string">&#x27;in_port&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 报文解析</span></span><br><span class="line">pkt = packet.Packet(msg.data)</span><br><span class="line">pkt_dhcp = pkt.get_protocol(dhcp.dhcp)</span><br><span class="line">eth = pkt.get_protocols(ethernet.ethernet)[<span class="number">0</span>]</span><br><span class="line">pkt_ipv4 = pkt.get_protocol(ipv4.ipv4)</span><br><span class="line">pkt_udp = pkt.get_protocol(udp.udp)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 找出上发该报文交换机对应的DHCP中继服务信息 若找到 记录网关IP地址及端口</span></span><br><span class="line"><span class="keyword">for</span> s, p, g <span class="keyword">in</span> self.dhcp_relay:</span><br><span class="line">    <span class="keyword">if</span> dpid == s:</span><br><span class="line">        gateway = g</span><br><span class="line">        link_port = p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历报文DHCP协议中options字段 找出并记录该报文对应的DHCP类型</span></span><br><span class="line"><span class="keyword">for</span> option <span class="keyword">in</span> pkt_dhcp.options:</span><br><span class="line">    <span class="keyword">if</span> option.tag == dhcp.DHCP_MESSAGE_TYPE_OPT:</span><br><span class="line">        dhcp_type = <span class="built_in">int</span>(<span class="built_in">str</span>(binascii.hexlify(option.value))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出相关信息</span></span><br><span class="line">self.logger.info(</span><br><span class="line">    <span class="string">&quot;Received a DHCP packet in dhcp-relay switch:&#123;&#125; port:&#123;&#125;  type:&#123;&#125;&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span>.<span class="built_in">format</span>(dpid, in_port, dhcp_type))</span><br></pre></td></tr></table></figure></div></details><details class="folding-tag" blue><summary>DHCP Discover 报文和DHCP Request报文的处理</summary><div class="content"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 判断DHCP报文类型是否为DISCOVER和REQUEST及保证报文接收端口正确</span></span><br><span class="line"><span class="keyword">if</span> (dhcp_type == dhcp.DHCP_DISCOVER <span class="keyword">or</span> dhcp_type == dhcp.DHCP_REQUEST) <span class="keyword">and</span> in_port == link_port:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(self.dhcp_link_stats) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># 随机选择一条与DHCP服务器连接的链路 并记录对应信息</span></span><br><span class="line">        index = random.randint(<span class="number">0</span>, <span class="built_in">len</span>(self.dhcp_link_stats) - <span class="number">1</span>)</span><br><span class="line">        send_switch = self.dhcp_link_stats[index][<span class="number">1</span>]</span><br><span class="line">        send_port = self.dhcp_link_stats[index][<span class="number">3</span>]</span><br><span class="line">        eth.dst = self.switch_adds[(self.dhcp_switch, self.dhcp_link_stats[index][<span class="number">2</span>])]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 判断源IP地址和目的IP地址 用于区分IP地址分配过程、更新过程、释放过程</span></span><br><span class="line">        <span class="keyword">if</span> pkt_ipv4.src == <span class="string">&quot;0.0.0.0&quot;</span> <span class="keyword">and</span> pkt_ipv4.dst == <span class="string">&quot;255.255.255.255&quot;</span>:</span><br><span class="line">            <span class="comment"># 修改相应信息</span></span><br><span class="line">            pkt_dhcp.hops += <span class="number">1</span></span><br><span class="line">            pkt_dhcp.giaddr = gateway</span><br><span class="line">            pkt_ipv4.src = gateway</span><br><span class="line">            pkt_ipv4.dst = self.dhcp_ip[<span class="built_in">int</span>(self.dhcp_link_stats[index][<span class="number">2</span>]) - <span class="number">1</span>]</span><br><span class="line">        <span class="comment"># 序列化修改后的报文并重新添加Padding</span></span><br><span class="line">        pkt_udp.csum = <span class="number">0</span></span><br><span class="line">        pkt.serialize()</span><br><span class="line">        msg.data = pkt.data + self.addPadding(<span class="built_in">len</span>(msg.data) - <span class="built_in">len</span>(pkt.data))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 判断hops字段是否小于等于16</span></span><br><span class="line">        <span class="keyword">if</span> pkt_dhcp.hops &lt;= <span class="number">16</span>:</span><br><span class="line">            <span class="comment"># 将报文从特定交换机的指定端口发送并输出信息</span></span><br><span class="line">            actions = [get_switch(self, send_switch)[<span class="number">0</span>].dp.ofproto_parser.OFPActionOutput(send_port)]</span><br><span class="line">            self.send_out(get_switch(self, send_switch)[<span class="number">0</span>], actions, msg.data)</span><br><span class="line">            self.logger.info(<span class="string">&quot;Send out a DHCP packet in dhcp-relay switch:&#123;&#125;  port:&#123;&#125;  type:&#123;&#125; \n&quot;</span>.<span class="built_in">format</span>(send_switch, send_port, dhcp_type))</span><br><span class="line"><span class="number">5.</span> DHCP Offer 报文和DHCP Ack报文的处理</span><br><span class="line"><span class="comment"># 判断DHCP报文类型是否为OFFER和ACK</span></span><br><span class="line"><span class="keyword">elif</span> dhcp_type == dhcp.DHCP_OFFER <span class="keyword">or</span> dhcp_type == dhcp.DHCP_ACK:</span><br><span class="line"><span class="comment"># 找出对应的中继交换机相关信息</span></span><br><span class="line"><span class="keyword">for</span> s, p, g <span class="keyword">in</span> self.dhcp_relay:</span><br><span class="line">    <span class="keyword">if</span> pkt_dhcp.giaddr == g:</span><br><span class="line">        send_switch = s</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 判断DHCP协议的flags字段是否为广播报文</span></span><br><span class="line">        <span class="keyword">if</span> pkt_dhcp.flags == <span class="number">0</span>:</span><br><span class="line">            eth.dst = pkt_dhcp.chaddr</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            eth.dst = <span class="string">&quot;ff:ff:ff:ff:ff:ff&quot;</span></span><br><span class="line">        <span class="comment"># 判断DHCP协议的yiaddr字段与目的IP地址是否相等 用于区分IP地址分配过程、更新过程、释放过程</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pkt_dhcp.yiaddr != pkt_ipv4.dst:</span><br><span class="line">            pkt_ipv4.src = pkt_dhcp.giaddr</span><br><span class="line">            pkt_ipv4.dst = pkt_dhcp.yiaddr</span><br><span class="line">        <span class="comment"># 修改目的端口正确 </span></span><br><span class="line">        pkt_udp.dst_port = <span class="number">68</span></span><br><span class="line">        <span class="comment"># 序列化修改后的报文并重新添加Padding</span></span><br><span class="line">        pkt_udp.csum = <span class="number">0</span></span><br><span class="line">        pkt.serialize()</span><br><span class="line">        msg.data = pkt.data + self.addPadding(<span class="built_in">len</span>(msg.data) - <span class="built_in">len</span>(pkt.data))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将报文从特定交换机的指定端口发送并输出信息</span></span><br><span class="line">        actions = [get_switch(self, send_switch)[<span class="number">0</span>].dp.ofproto_parser.OFPActionOutput(p)]</span><br><span class="line">        self.send_out(get_switch(self, send_switch)[<span class="number">0</span>], actions, msg.data)</span><br><span class="line">        self.logger.info(<span class="string">&quot;Send out a DHCP packet in dhcp-relay switch:&#123;&#125;  port:&#123;&#125;  type:&#123;&#125; \n&quot;</span>.<span class="built_in">format</span>(send_switch, p, dhcp_type))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div></details><p>（二）结果分析</p><ul><li><p>DHCP服务请求</p><p>对h1进行DHCP服务的请求，并查看h1的IP地址。如下图，h1成功分配到IP地址192.168.1.3。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718121350045.png" alt="查看h1的IP地址"></p></li><li><p>抓包分析</p><p>在h1进行DHCP服务请求的过程中，分别对h1-eth1、dhcp-eth1和dhcp-eth2三个端口进行抓包。</p><p>首先，如下图，在dhcp-eth2端口接收到了DHCP Discover报文，在dhcp-eth1端口接收到了DHCP Offer、DHCP Request和DHCP ACK报文，说明实现了DHCP服务器的负载均担。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718121514452.png" alt="报文分析"></p><p>如下图，在h1的Discover报文中，可以看到中继服务器的IP地址被标识为0.0.0.0，而经过控制器的修改，发送到DHCP服务器的中继服务器的IP地址被修改为192.168.1.254。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718121547743.png" alt="报文分析"></p><p>如下图，在DHCP服务器发送的Offer报文中，源IP地址是192.168.0.1，目的IP地址是192.168.1.254。经过控制器的修改后，h1收到的Offer报文中源IP地址被成功修改为中继交换机的IP，即192.168.1.254，目的IP地址被修改为分配给h1的IP地址，即192.168.1.3。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718121618956.png" alt="报文分析"></p><p>后续的Request报文和ACK报文也由控制器进行相应的修改，与上述两个报文类似。</p></li><li><p>连通性验证</p><p>对h1进行DHCP请求后，再次对不同子网下的h5进行同样的DHCP请求操作，成功获取IP地址后，测试h1和h5的连通性，如下图，可以发现能够成功ping通。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718121702956.png" alt="ping通展示"></p></li></ul><h2 id="服务器实现与分析">服务器实现与分析</h2><p>（一）实现</p><p>在主干网的服务器集群中，我们需要对三种服务器进行配置，即反向代理服务器、Web服务器、FTP服务器。其中反向代理服务器拥有两张网卡分别与Mininet拓扑和Web服务器集群连接，我们将两台反向代理服务器与Mininet拓扑连接的网卡IP地址配置为192.168.4.1、192.168.4.2，将其与Web服务器集群连接的网卡IP配置为172.168.1.3、172.168.1.4；Web服务器和FTP服务器都只拥有一张网卡，将两台Web服务器IP配置为172.168.1.1、172.168.1.2，FTP服务器IP配置为192.168.4.5。下面对各种服务器进行单独的配置说明。</p><details class="folding-tag" blue><summary>反向代理服务器配置</summary><div class="content"><p>在反向代理服务器中，我们基于nginx的代理机制实现对Web服务器集群的反向代理，成功安装nginx后，修改/etc/nginx/conf.d/default.conf文件配置如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// 配置Web服务器地址池</span><br><span class="line">upstream phpserver1 &#123;</span><br><span class="line">    server <span class="number">172.168</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">80</span>;</span><br><span class="line">    server <span class="number">172.168</span><span class="number">.1</span><span class="number">.2</span>:<span class="number">80</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 配置反向代理服务器映射方法（其中<span class="number">200</span>和<span class="number">210</span>为虚拟IP在VRRP部分会进一步介绍）</span><br><span class="line">server &#123;</span><br><span class="line">        listen       <span class="number">80</span>;</span><br><span class="line">        server_name  <span class="number">192.168</span><span class="number">.4</span><span class="number">.200</span>;</span><br><span class="line">        server_name  <span class="number">192.168</span><span class="number">.4</span><span class="number">.210</span>;</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass   http://phpserver1;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div></details><details class="folding-tag" blue><summary>Web服务器配置</summary><div class="content"><p>在Web服务器中，我们同样是基于nginx的代理机制实现对Web服务，成功安装nginx后，修改/etc/nginx/conf.d/default.conf文件配置如下:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// 配置Web服务器端口和文件位置</span><br><span class="line">server &#123;</span><br><span class="line">    listen       <span class="number">80</span>;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></details><details class="folding-tag" blue><summary>FTP服务器配置</summary><div class="content"><p>在FTP服务器中，我们基于开源软件vsftpd实现FTP服务，成功安装vsftpd后，修改/etc/vsftpd/vsftpd.conf文件配置如下:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 是否开启匿名用户，匿名都不安全，默认NO</span></span><br><span class="line">anonymous_enable=NO</span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许本机账号登录FTP</span></span><br><span class="line">local_enable=YES</span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许账号都有写操作</span></span><br><span class="line">write_enable=YES</span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地用户创建文件或目录的掩码</span></span><br><span class="line">local_umask=022</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入某个目录的时候，是否在客户端提示一下</span></span><br><span class="line">dirmessage_enable=YES</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当设定为YES时，使用者上传与下载日志都会被记录起来</span></span><br><span class="line">xferlog_enable=YES</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志成为std格式</span></span><br><span class="line">xferlog_std_format=YES</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传与下载日志存放路径</span></span><br><span class="line">xferlog_file=/var/log/xferlog</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开放port模式的20端口的连接</span></span><br><span class="line">connect_from_port_20=YES</span><br><span class="line"></span><br><span class="line"><span class="comment"># 与上一个设定类似的，只是这个设定针对上传而言，预设是NO</span></span><br><span class="line">ascii_upload_enable=NO</span><br><span class="line">ascii_download_enable=NO</span><br><span class="line"></span><br><span class="line"><span class="comment"># 限制用户只能在自己的目录活动</span></span><br><span class="line">chroot_local_user=YES</span><br><span class="line">chroot_list_enable=NO</span><br><span class="line">chroot_list_file=/etc/vsftpd/chroot_list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监听ipv4端口，开了这个就说明vsftpd可以独立运行，不用依赖其他服务</span></span><br><span class="line">listen=NO</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监听ipv6端口</span></span><br><span class="line">listen_ipv6=YES</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开主动模式</span></span><br><span class="line">port_enable=YES</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动被动式联机(passivemode)</span></span><br><span class="line">pasv_enable=YES</span><br><span class="line"></span><br><span class="line"><span class="comment"># 被动模式起始端口，0为随机分配</span></span><br><span class="line">pasv_min_port=<span class="number">64000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 被动模式结束端口，0为随机分配</span></span><br><span class="line">pasv_max_port=<span class="number">65000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个是pam模块的名称，我们放置在/etc/pam.d/vsftpd，认证用</span></span><br><span class="line">pam_service_name=vsftpd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用允许登录的名单，在/etc/vsftpd/user_list文件中添加新建的用户ftpuser</span></span><br><span class="line">userlist_enable=YES</span><br><span class="line"></span><br><span class="line"><span class="comment"># 限制允许登录的名单，前提是userlist_enable=YES，其实这里有点怪,禁止访问名单在/etc/vsftpd/ftpusers</span></span><br><span class="line">userlist_deny=NO</span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许限制在自己的目录活动的用户拥有写权限</span></span><br><span class="line">allow_writeable_chroot=YES</span><br><span class="line"></span><br><span class="line"><span class="comment"># FTP访问目录</span></span><br><span class="line">local_root=/data/ftp/ftpuser</span><br><span class="line">pasv_promiscuous=YES</span><br></pre></td></tr></table></figure></div></details><p>（二）结果分析</p><ul><li><p>Web服务器与负载分担</p><p>此处我们采用了负载均担技术，即可以将外部的Web请求映射到两台相同的Web服务器上。</p><p>两台Web服务器的IP地址分别为172.168.1.1和172.168.1.2，如下图。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718122419748.png" alt="IP展示"></p><p>在h1的浏览器中访问192.168.4.200，可以看到负载会被分担到两台Web服务器上，如下图。在正常情况下，访问时会出现相同的页面，这里为了区分设置了两种不同的页面来代表访问不同的Web服务器。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718122446011.png" alt="web页面"></p></li><li><p>FTP服务器</p><p>我们FTP服务器的IP地址为192.168.4.5。首先登录FTP服务器，查看目录，找到相应需要接收的文件1.txt。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718122803636.png" alt="进入目录"></p><p>在命令行中接收该文件，并在文件夹中查看，可以看到文件被准确无误地从FTP服务器上接收。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718122859276.png" alt="FTP文件接收"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718122926796.png" alt="打开文件"></p></li></ul><h2 id="vrrp高可用实现与分析">VRRP高可用实现与分析</h2><p>（一）实现</p><details class="folding-tag" blue><summary>反向代理服务器之间的高可用配置</summary><div class="content"><p>在反向代理服务器中，我们基于开源软件Keepalived实现了反向代理服务器之间基于VRRP协议的高可用配置，在成功安装Keepalived软件后，修改/etc/keepalived/keepalived.conf文件进行配置。</p><p>前面提到我们有两台反向代理服务器，且与Mininet拓扑连接的网卡IP配置分别为192.168.4.1和192.168.4.2，我们指定前一台反向代理服务器为router_id Nginx_01、后一台为router_id Nginx_02。在此时的高可用配置中，我们使用双主配置的方式，创建两个虚拟IP 192.168.4.200和192.168.4.210，且配置router_id Nginx_01为192.168.4.200的主服务器（即优先级更高），router_id Nginx_02为192.168.4.210的主服务器，各自配置文件如下。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;               </span><br><span class="line">   router_id Nginx_01</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script check_nginx &#123;</span><br><span class="line">	script <span class="string">&quot;/etc/keepalived/check_nginx.sh&quot;</span></span><br><span class="line">	interval <span class="number">2</span></span><br><span class="line">    weight -<span class="number">5</span></span><br><span class="line">    fall <span class="number">3</span></span><br><span class="line">    rise <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens32</span><br><span class="line">    virtual_router_id <span class="number">51</span></span><br><span class="line">    priority <span class="number">150</span></span><br><span class="line">    advert_int <span class="number">1</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass <span class="number">1111</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">     <span class="number">192.168</span><span class="number">.4</span><span class="number">.200</span></span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">    	check_nginx</span><br><span class="line">    &#125;</span><br><span class="line">&#125;   </span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens32</span><br><span class="line">    virtual_router_id <span class="number">52</span></span><br><span class="line">    priority <span class="number">100</span></span><br><span class="line">    advert_int <span class="number">1</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass <span class="number">1111</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">     <span class="number">192.168</span><span class="number">.4</span><span class="number">.210</span></span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">    	check_nginx</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;               </span><br><span class="line">   router_id Nginx_02</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script check_nginx &#123;</span><br><span class="line">	script <span class="string">&quot;/etc/keepalived/check_nginx.sh&quot;</span></span><br><span class="line">	interval <span class="number">2</span></span><br><span class="line">    weight -<span class="number">5</span></span><br><span class="line">    fall <span class="number">3</span></span><br><span class="line">    rise <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens32</span><br><span class="line">    virtual_router_id <span class="number">51</span></span><br><span class="line">    priority <span class="number">100</span></span><br><span class="line">    advert_int <span class="number">1</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass <span class="number">1111</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">     <span class="number">192.168</span><span class="number">.4</span><span class="number">.200</span></span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">    	check_nginx</span><br><span class="line">    &#125;</span><br><span class="line">&#125;   </span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens32</span><br><span class="line">    virtual_router_id <span class="number">52</span></span><br><span class="line">    priority <span class="number">150</span></span><br><span class="line">    advert_int <span class="number">1</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass <span class="number">1111</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">     <span class="number">192.168</span><span class="number">.4</span><span class="number">.210</span></span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">    	check_nginx</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></details><details class="folding-tag" blue><summary>反向代理服务器对服务器的代理</summary><div class="content"><p>这一配置在服务器部分有提及，此处进行进一步解释。在我们的反向代理服务器中，由于实现了高可用的配置，对反向代理服务器的访问需要通过虚拟IP访问才能保障高可靠服务的有效性。因此我们在配置反向代理时也需要将nginx代理的IP地址修改为我们定义的虚拟IP地址，即192.168.4.200和192.168.4.210。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// 配置Web服务器地址池</span><br><span class="line">upstream phpserver1 &#123;</span><br><span class="line">    server <span class="number">172.168</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">80</span>;</span><br><span class="line">    server <span class="number">172.168</span><span class="number">.1</span><span class="number">.2</span>:<span class="number">80</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 配置反向代理服务器映射方法（其中<span class="number">200</span>和<span class="number">210</span>为虚拟IP）</span><br><span class="line">server &#123;</span><br><span class="line">        listen       <span class="number">80</span>;</span><br><span class="line">        server_name  <span class="number">192.168</span><span class="number">.4</span><span class="number">.200</span>;</span><br><span class="line">        server_name  <span class="number">192.168</span><span class="number">.4</span><span class="number">.210</span>;</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass   http://phpserver1;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div></details><p>（二）结果分析</p><ul><li><p>VRRP验证</p><p>对于两台反向代理服务器nginx1和nginx2，他们映射有VRRP机制下的虚拟IP地址。如下图，nginx1有真实IP地址192.168.4.1，也有虚拟IP地址192.168.4.200；nginx2有真实IP地址192.168.4.2，也有虚拟IP地址192.168.4.210。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718121939887.png" alt="IP展示"></p><p>在h1的xterm下打开浏览器，依次访问192.168.4.200和192.168.4.210，如下图，均可以访问到Web服务器。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718122023094.png" alt="访问web服务器"></p><p>暂停nginx1的反向代理服务器来检测VRRP的有效性，即关闭nginx代理服务和keepalived服务。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718122056813.png" alt="关闭代理服务"></p><p>查看nginx1的IP地址，可以看到虚拟IP地址已经消失，只剩下真实IP地址192.168.4.1。这相当于nginx1这台反向代理服务器出现差错，无法继续工作，正常情况下，另一台代理服务器会接替这台出现差错的代理服务器。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718122132806.png" alt="IP展示"></p><p>我们再查看nginx2的IP地址，可以看到，在原来两个IP地址的基础上，多出了192.168.4.200这一虚拟IP地址，说明其接替了nginx1的工作。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718122158719.png" alt="IP展示"></p><p>再次在h1的浏览器中测试两个虚拟IP地址，均成功访问，VRRP技术验证成功。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718122233770.png" alt="web服务器访问"></p></li></ul><h2 id="gre隧道实现与分析">GRE隧道实现与分析</h2><p>（一）实现</p><details class="folding-tag" blue><summary>反向代理服务器对服务器的代理</summary><div class="content"><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230717234325368.png" alt="image-20230717234325368"></p><p>在我们设计的网络中，主干网和分支网是位于两台虚拟机上的Mininet拓扑，想要实现两者通过隧道的通信，首先我们需要在两台虚拟机之间搭建隧道连接。对我们的拓扑分析，外面需要连通的是主干网的服务器集群网络192.168.4.0/24和分支网的主机网络192.168.6.0/24，我们需要搭建用于传输这两个网段的隧道。由于Linux内核已经系统级的支持GRE隧道，因此我们只需要在系统中编写并执行脚本便可以实现隧道的搭建。两台虚拟机的脚本文件如下。</p><p>主干网脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 在主干网和分支网虚拟机IP之间搭建GRE隧道并启动</span><br><span class="line">ip tunnel add Tunnel-<span class="number">1</span> mode gre remote <span class="number">192.168</span><span class="number">.106</span><span class="number">.242</span> local <span class="number">192.168</span><span class="number">.106</span><span class="number">.171</span></span><br><span class="line">ifconfig Tunnel-<span class="number">1</span> up</span><br><span class="line">// 配置隧道的网段</span><br><span class="line">ip addr add <span class="number">192.168</span><span class="number">.6</span><span class="number">.1</span>/<span class="number">24</span> dev Tunnel-<span class="number">1</span></span><br><span class="line">// 配置隧道的路由表项</span><br><span class="line">ip route add <span class="number">192.168</span><span class="number">.4</span><span class="number">.0</span>/<span class="number">24</span> dev Tunnel-<span class="number">1</span></span><br></pre></td></tr></table></figure><p>分支网脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 在主干网和分支网虚拟机IP之间搭建GRE隧道并启动</span><br><span class="line">ip tunnel add Tunnel-<span class="number">1</span> mode gre remote <span class="number">192.168</span><span class="number">.106</span><span class="number">.171</span> local <span class="number">192.168</span><span class="number">.106</span><span class="number">.242</span></span><br><span class="line">ifconfig Tunnel-<span class="number">1</span> up</span><br><span class="line">// 配置隧道的网段</span><br><span class="line">ip addr add <span class="number">192.168</span><span class="number">.4</span><span class="number">.1</span>/<span class="number">24</span> dev Tunnel-<span class="number">1</span></span><br><span class="line">// 配置隧道的路由表项</span><br><span class="line">ip route add <span class="number">192.168</span><span class="number">.6</span><span class="number">.0</span>/<span class="number">24</span> dev Tunnel-<span class="number">1</span></span><br></pre></td></tr></table></figure></div></details><details class="folding-tag" blue><summary>主干网和分支网通过隧道的连通</summary><div class="content"><p>通过文件配置读取的形式向控制器导入隧道的相关信息。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230717234821457.png" alt="隧道相关信息的配置"></p><p>编写代码实现文本配置隧道信息的读取并初始化控制器:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 读取隧道连接的内部网络信息</span></span><br><span class="line">self.vpn_innet = content[<span class="number">10</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>).split(<span class="string">&#x27;=&#x27;</span>)[-<span class="number">1</span>].split(<span class="string">&#x27;;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-----------------------vpn_innet:  &#123;&#125;---------------------&quot;</span>.<span class="built_in">format</span>(self.vpn_innet))</span><br><span class="line"><span class="comment"># 读取隧道连接的外部网络信息</span></span><br><span class="line">self.vpn_outnet = content[<span class="number">11</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>).split(<span class="string">&#x27;=&#x27;</span>)[-<span class="number">1</span>].split(<span class="string">&#x27;;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-----------------------vpn_innet:  &#123;&#125;---------------------&quot;</span>.<span class="built_in">format</span>(self.vpn_outnet))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>报文的获取及初步处理:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 源和目的IP都为隧道网段 进行处理</span></span><br><span class="line"><span class="keyword">if</span> self.ipINvpn(pkt_ipv4.src) <span class="keyword">and</span> self.ipINvpn(pkt_ipv4.dst):</span><br><span class="line">    self.vpn_handler(msg)</span><br></pre></td></tr></table></figure><p>隧道报文的处理:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">vpn_handler</span>(<span class="params">self, msg</span>):</span><br><span class="line">    <span class="comment"># 读取报文相关信息</span></span><br><span class="line">    datapath = msg.datapath</span><br><span class="line">    parser = datapath.ofproto_parser</span><br><span class="line">    in_port = msg.<span class="keyword">match</span>[<span class="string">&#x27;in_port&#x27;</span>]</span><br><span class="line">    pkt = packet.Packet(msg.data)</span><br><span class="line">    eth = pkt.get_protocols(ethernet.ethernet)[<span class="number">0</span>]</span><br><span class="line">    pkt_ipv4 = pkt.get_protocol(ipv4.ipv4)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 寻找最短路并输出</span></span><br><span class="line">    shortest_path = self.topo.Dijkstra(</span><br><span class="line">        datapath.<span class="built_in">id</span>, self.nat_switch_id, in_port, self.nat_switch_port</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(shortest_path) &gt; <span class="number">0</span></span><br><span class="line">    path_str = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> s, ip, op <span class="keyword">in</span> shortest_path:</span><br><span class="line">        path_str = path_str + <span class="string">&quot;--&#123;&#125;-&#123;&#125;-&#123;&#125;--&quot;</span>.<span class="built_in">format</span>(ip, s, op)</span><br><span class="line">    self.logger.info(<span class="string">&quot;Configure the shortset path from &#123;&#125; to &#123;&#125; —— &#123;&#125;\n&quot;</span>.<span class="built_in">format</span>(pkt_ipv4.src, pkt_ipv4.dst, path_str))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 下发流表项</span></span><br><span class="line">    self.configure_path(shortest_path, msg, eth.src, eth.dst, pkt_ipv4.dst)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将报文从NAT交换机发送</span></span><br><span class="line">    actions = [parser.OFPActionOutput(self.nat_switch_port)]</span><br><span class="line">    self.send_out(self.nat_switch, actions, pkt.data)</span><br></pre></td></tr></table></figure></div></details><p>（二）结果分析</p><ul><li><p>隧道连通性验证</p><p>启动GRE隧道，在隧道两端，我们连接主干网的服务器部分（网段为192.168.4.0）和分支网的主机部分（网段为192.168.6.0）。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718123212382.png" alt="启动GRE隧道"></p><p>用IP为192.168.6.1的主机ping IP为192.168.4.1的服务器，可以看到能够成功ping通。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718123256546.png" alt="ping通展示"></p></li><li><p>抓包分析</p><p>可以看到，抓取到的报文具有两层IP结构，即还有一层IP结构为Generic Routing Encapsulation(GRE)，证明GRE隧道有效。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718123335758.png" alt="抓包分析"></p></li><li><p>主干、分支网连通性验证</p><p>启动拓扑，接下来验证分支网可以通过两种方式来访问主干网的服务器。</p><p>首先进行ICMP测试，可以看到，分支网可以成功ping通主干网的Web服务器（192.168.4.1）和FTP服务器（192.168.4.5）。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718123432051.png" alt="连通性验证"></p><p>再验证TCP服务和UDP服务。在分支网打开浏览器，先使用公网IP 192.168.106.242进行访问，可以看到访问成功，且负载分担正常。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718123501506.png" alt="访问web服务器"></p><p>采用私网IP（192.168.4.200和192.168.4.210），即隧道的方式进行访问，可以看到两个虚拟IP均可以正常访问。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718123527014.png" alt="访问web服务器"></p><p>用隧道的方式连接FTP服务器，可以成功登录，使用get指令后文件成功获取，GRE隧道验证成功。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718123611477.png" alt="登录服务器"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/image-20230718123655499.png" alt="获取文件成功"></p></li></ul><h1 id="总结">总结</h1><p>本次项目设计中，首先通过我们自己设计并实现的协议，完成了SDN网络的配置，验证了拓扑中各个主机的联通性，同时实现了流量的监控与管理；</p><p>其次实现了通过NAPT对外网的访问，在这一点上，我们优化了本身实现的NAT，完成了NAPT的搭建；</p><p>接着实现了DHCP中继，使各个主机可以通过向DHCP服务器申请的方式获得自身的IP地址，减少了网络管理员手动配置的工作量；</p><p>然后实现了包含负载均担的服务器的搭建，并且通过防火墙的设置，完成了不同子网访问服务器的限制；</p><p>再然后实现了基于VRRP协议的高可用配置，为我们设计实现的中小型网络增加了出故障之后的处理能力，提高了鲁棒性；</p><p>最后，通过实现GRE隧道，实现了不同网络之间的相互访问。</p><p>到此为止，我们完成了整个项目设计目标——中小型网络的搭建，完成了在有限的计算机和网络设备的条件下，通过选择合适的硬件和软件，构建一个适合中小规模组织使用的网络系统。</p></article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>中小型园区网络构建（二）—— SDN网络应用的设计与实现</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://asa-world.cn/b11f40b7/">https://asa-world.cn/b11f40b7/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a" style="display:inline-block;width:120px"><h>作者</h><div class="post-copyright-cc-info"><h>阿傻</h></div></div><div class="post-copyright-c" style="display:inline-block;width:120px"><h>发布于</h><div class="post-copyright-cc-info"><h>2023-07-17</h></div></div><div class="post-copyright-u" style="display:inline-block;width:120px"><h>更新于</h><div class="post-copyright-cc-info"><h>2023-09-12</h></div></div><div class="post-copyright-c" style="display:inline-block;width:120px"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener external nofollow noreferrer" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener external nofollow noreferrer" target="_blank" title="CC BY 4.0" href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC BY 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post_share"><div class="social-share" data-image="https://image.asa-world.cn/pic/1242.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://lib.baomitu.com/social-share.js/1.0.16/css/share.min.css" media="print" onload='this.media="all"'><script src="https://lib.baomitu.com/social-share.js/1.0.16/js/social-share.min.js" defer></script></div></div><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/ed5df591/" title="中小型园区网络构建（一） —— SDN网络及其构建"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/1242.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-06</div><div class="title">中小型园区网络构建（一） —— SDN网络及其构建</div></div></a></div><div><a href="/fd05d161/" title="使用SDN网络架构的Kruskal算法实践"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://asa-world-1309727865.cos.ap-chengdu.myqcloud.com/pic/image-20230104222629771.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-26</div><div class="title">使用SDN网络架构的Kruskal算法实践</div></div></a></div><div><a href="/e9c4a133/" title="使用SDN网络架构的DFS算法实践项目"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://asa-world-1309727865.cos.ap-chengdu.myqcloud.com/pic/image-20230104221003576.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-03</div><div class="title">使用SDN网络架构的DFS算法实践项目</div></div></a></div><div><a href="/5c5a2704/" title="使用SDN网络架构的Ford-Fulkerson算法实践"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://asa-world-1309727865.cos.ap-chengdu.myqcloud.com/pic/image-20230104195838606.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-23</div><div class="title">使用SDN网络架构的Ford-Fulkerson算法实践</div></div></a></div><div><a href="/39935ec6/" title="使用SDN网络架构的dijkstra算法实践"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://asa-world-1309727865.cos.ap-chengdu.myqcloud.com/pic/image-20230104215402312.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-04</div><div class="title">使用SDN网络架构的dijkstra算法实践</div></div></a></div><div><a href="/2a47880c/" title="mininet拓扑搭建"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://asa-world-1309727865.cos.ap-chengdu.myqcloud.com/pic/image-20230104223447787.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-21</div><div class="title">mininet拓扑搭建</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><body><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><div class="author-info__sayhi" id="author-info__sayhi">下午好！我是</div><div class="author-info__name">Asa</div><div class="author-info__description">这里有关于<b>项目、设计、开发</b>相关的问题和看法，还有<b>生活思考</b>和<b>分享</b>。</div><div class="author-info__description2">相信你可以在这里找到对你有用的<b>知识</b>和<b>教程</b>。</div></div></div><div class="banner-button-group"><a class="banner-button" onclick='window.location.href="/about/"' data-pjax-state="data-pjax-state"><i class="fas fa-circle-chevron-right"></i><span class="banner-button-text">了解更多</span></a></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener external nofollow" href="https://github.com/asa-world"><i class="fab fa-github"></i><span>Github</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:asa-world@qq.com" rel="external nofollow" target="_blank" title="e-mail"><i class="iconfont icon-youjian"></i></a><a class="social-icon" href="https://github.com/asa-world" rel="external nofollow" target="_blank" title="Github"><i class="iconfont icon-github"></i></a></div></div></body><div class="card-widget card-proinfo"><div id="card-environment"><i class="iconfont icon-line-052"></i><span>开发环境：Ubuntu 18.04</span></div><div id="card-language"><i class="iconfont icon-code"></i><span>开发语言：Python</span></div><div id="card-github"><a class="banner-button" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/asa-world/SDN-NET"><i class="iconfont icon-github"></i><span class="banner-button-text">项目地址</span></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%BA%94%E7%94%A8%E4%BB%8B%E7%BB%8D%E5%8F%8A%E5%8E%9F%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">网络应用介绍及原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#napt%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">NAPT介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E7%81%AB%E5%A2%99%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.</span> <span class="toc-text">防火墙介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dhcp%E4%B8%AD%E7%BB%A7%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.3.</span> <span class="toc-text">DHCP中继介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vrrp%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.4.</span> <span class="toc-text">VRRP介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.5.</span> <span class="toc-text">应用服务器介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gre%E9%9A%A7%E9%81%93%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.6.</span> <span class="toc-text">GRE隧道介绍</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.</span> <span class="toc-text">方案设计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#napt%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.1.</span> <span class="toc-text">NAPT设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E7%81%AB%E5%A2%99%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.2.</span> <span class="toc-text">防火墙设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dhcp%E4%B8%AD%E7%BB%A7%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.3.</span> <span class="toc-text">DHCP中继设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.4.</span> <span class="toc-text">应用服务器设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Evrrp%E5%8D%8F%E8%AE%AE%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.5.</span> <span class="toc-text">基于VRRP协议的高可用设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gre%E9%9A%A7%E9%81%93%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.6.</span> <span class="toc-text">GRE隧道设计</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E5%AE%9E%E7%8E%B0%E4%B8%8E%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">方案实现与结果分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#napt%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90"><span class="toc-number">3.1.</span> <span class="toc-text">NAPT实现与分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E7%81%AB%E5%A2%99%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90"><span class="toc-number">3.2.</span> <span class="toc-text">防火墙实现与分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dhcp%E4%B8%AD%E7%BB%A7%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90"><span class="toc-number">3.3.</span> <span class="toc-text">DHCP中继实现与分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90"><span class="toc-number">3.4.</span> <span class="toc-text">服务器实现与分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vrrp%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90"><span class="toc-number">3.5.</span> <span class="toc-text">VRRP高可用实现与分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gre%E9%9A%A7%E9%81%93%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90"><span class="toc-number">3.6.</span> <span class="toc-text">GRE隧道实现与分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background:0 0"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Asa</div><a class="footr" target="_blank" rel="noopener external nofollow noreferrer" href="https://beian.miit.gov.cn/"><div id="foot_r">冀ICP备2023001417号-1</div></a><div id="jing-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image.asa-world.cn/pic/%E5%A4%87%E6%A1%88%E5%9B%BE%E6%A0%87.png" alt="Page not found"></div><div id="foot_b">冀公网安备13092702000364号</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="iconfont icon-moonbyueliang"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="iconfont icon-doubleHorizontalArrow"></i></button></div><div id="rightside-config-show"><button id="sentence" type="button" title="暖心句子"><i class="iconfont icon-liuyan"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="iconfont icon-liebiao1"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="iconfont icon-pinglun"></i></a></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/third_local/fancybox_umd_min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/node-snackbar/0.1.16/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script>var loader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",loader.endLoading())</script><div class="js-pjax"><script>(()=>{const t=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://twikoo.asa-world.cn/",region:"",onCommentLoaded:function(){btf.loadLightbox(document.querySelectorAll("#twikoo .tk-content img:not(.tk-owo-emotion)"))}},{cdn:"1.6.4"}))},o=()=>{"object"!=typeof twikoo?getScript("https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js").then(t):setTimeout(t,0)};o()})()</script></div><script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.3/jquery.min.js"></script><canvas id="universe"></canvas><script data-pjax defer src="/js/universe.js"></script><script src="/zhheo/random.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js/lib/typed.min.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="/third_local/fireworks_min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>